<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Entertainment Index</title>
    <!-- SheetJS library for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Prevent flash of wrong theme by setting theme before CSS loads
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <nav class="main-nav">
            <a href="#" class="nav-link" id="aboutLink">about</a>
            <span class="separator">¬∑</span>
            <a href="#" class="nav-link" id="themeToggle">light</a>
        </nav>

        <div class="main-content" id="mainContent">
            <div class="content-wrapper">
                <header>
                    <div class="masthead">GEI</div>
                    <div class="header-info">
                        <div class="site-title">Game Entertainment Index</div>
                        <div class="week-info" id="headerWeekInfo">Week 16 ¬∑ December 28, 2025</div>
                    </div>
                </header>

                <div class="selection-interface">
                    <div class="sport-selector" style="position: relative;">
                        <span class="sport-option active" data-sport="NFL" id="nflOption">nfl</span>
                        <span class="separator">¬∑</span>
                        <span class="sport-option" data-sport="CFB" id="cfbOption">cfb<span class="beta-label">beta</span></span>
                        <span class="separator">¬∑</span>
                        <span class="sport-option" data-sport="NBA" id="nbaOption">nba<span class="beta-label">beta</span></span>
                        <span class="separator">¬∑</span>
                        <span class="find-game-link" id="findGameLink">find a game</span>

                        <!-- Team Picker Dropdown -->
                        <div class="team-picker" id="teamPicker">
                            <input type="text" class="team-search-input" placeholder="search teams..." id="teamSearchInput">
                            <div class="team-list" id="teamList">
                                <!-- Filtered teams appear here -->
                            </div>
                        </div>
                    </div>
                    <div class="season-week-selector" id="weekSelector" style="position: relative;">
                        <a href="#" class="week-nav-link" id="prevWeek">‚Üê week <span id="prevWeekNum"></span></a>
                        <span class="separator">¬∑</span>
                        <span class="current-selection" id="currentWeekDisplay">2024 ¬∑ week 16</span>
                        <span class="separator">¬∑</span>
                        <a href="#" class="week-nav-link" id="nextWeek">week <span id="nextWeekNum"></span> ‚Üí</a>

                        <!-- Week Picker Dropdown -->
                        <div class="week-picker" id="weekPicker">
                            <div class="season-selector">
                                <span class="season-selector-label">season</span>
                                <div class="season-buttons" id="seasonButtons">
                                    <!-- Season buttons populated by JS -->
                                </div>
                            </div>
                            <div class="week-picker-header">select week</div>
                            <div class="week-grid" id="weekGrid">
                                <!-- Week buttons populated by JS -->
                            </div>
                        </div>
                    </div>
                    <div class="season-week-selector" id="dateSelector" style="position: relative; display: none;">
                        <a href="#" class="week-nav-link" id="prevDate">‚Üê <span id="prevDateDisplay"></span></a>
                        <span class="separator">¬∑</span>
                        <span class="current-selection" id="currentDateDisplay">yesterday</span>
                        <span class="separator">¬∑</span>
                        <a href="#" class="week-nav-link" id="nextDate"><span id="nextDateDisplay"></span> ‚Üí</a>

                        <!-- Custom Date Picker Dropdown -->
                        <div class="date-picker" id="customDatePicker">
                            <div class="date-picker-header">
                                <span class="date-picker-month" id="pickerMonthYear">December 2025</span>
                                <div class="date-picker-nav">
                                    <button class="date-picker-nav-btn" id="prevMonth">‚Üê</button>
                                    <button class="date-picker-nav-btn" id="nextMonth">‚Üí</button>
                                </div>
                            </div>
                            <div class="date-grid" id="dateGrid">
                                <div class="date-grid-header">S</div>
                                <div class="date-grid-header">M</div>
                                <div class="date-grid-header">T</div>
                                <div class="date-grid-header">W</div>
                                <div class="date-grid-header">T</div>
                                <div class="date-grid-header">F</div>
                                <div class="date-grid-header">S</div>
                                <!-- Date cells populated by JS as direct children -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="resultsArea">
                    <!-- Results populated by JavaScript -->
                </div>

                <div class="footer">
                    <p class="footer-text">
                        Entertainment scores reflect game dynamics including score margin, lead changes, and overtime.
                        <br><br>
                        <a href="#" class="footer-link" id="exportSeasonLink">export data</a>
                    </p>
                </div>
            </div>
        </div>

        <div class="about-content hidden" id="aboutContent">
            <div class="content-wrapper">
                <header>
                    <div class="masthead">GEI</div>
                    <div class="header-info">
                        <div class="site-title">Game Entertainment Index</div>
                    </div>
                </header>

                <section class="about-section">
                    <h3>Who am I?</h3>
                    <p>I'm Matthew Silverman. I work in financial communications in New York.</p>
                </section>

                <section class="about-section">
                    <h3>What is this?</h3>
                    <p>I built this site to solve a problem I kept running into as a sports fan: how do you know which past games are worth watching without seeing the score?</p>
                    <p>The site pulls win probability data from ESPN and runs it through an algorithm. Win probability graphs contain information that final scores don't. A 24-21 game could be a back-and-forth thriller or a blowout that got close in garbage time. The model tries to tell the difference.</p>
                </section>

                <section class="about-section">
                    <h3>How it works</h3>
                    <p>The algorithm analyzes win probability data across three independent dimensions:</p>

                    <table class="about-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Description</th>
                                <th>Calculation</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Outcome Uncertainty</td>
                                <td>How long was the result in doubt?</td>
                                <td>Time-weighted integral of <code>1 - |prob - 0.5|</code> across all data points. A game at 50/50 the entire time scores 10; a wire-to-wire blowout scores near 0.</td>
                            </tr>
                            <tr>
                                <td>Momentum Drama</td>
                                <td>How big were the swings, when they mattered?</td>
                                <td>Leverage-weighted movement: <code>Œ£(|Œîprob| √ó p √ó (1-p))</code>. Swings near 50/50 count fully; swings when the game is decided contribute almost nothing.</td>
                            </tr>
                            <tr>
                                <td>Finish Quality</td>
                                <td>Did it come down to the wire?</td>
                                <td>Final-period volatility plus proximity to 0.5 at game end, with a bonus for walk-off moments (swing > 0.15 in final data points).</td>
                            </tr>
                        </tbody>
                    </table>

                    <p>Of these metrics, finish quality carries the most weight (40%). This is a judgement call on my part but I think a boring first three quarters followed by a dramatic finish is more watchable than a close game that gets decided early in the fourth.</p>
                </section>

                <section class="about-section">
                    <h3>Flaws in this approach</h3>
                    <p>This model reflects one definition of entertaining: competitive games with meaningful swings and late drama. It won't flag a defensive masterpiece, a historic individual performance, or a rivalry game that matters for reasons the data can't see.</p>
                    <p>Which raises interesting questions on its own. What makes something worth watching? Can you quantify it? Where does the model fail, and what does that reveal about what we actually value? I don't have great answers but am open to any thoughts.</p>
                </section>

                <section class="about-section">
                    <h3>Feedback & contact</h3>
                    <p>This is a hobby project and a work in progress. If you have suggestions, see something broken, or want to discuss the methodology, I'd love to hear from you.</p>
                    <p>
                        <a href="mailto:mjsilverman19@gmail.com">mjsilverman19@gmail.com</a> ¬∑
                        <a href="https://www.linkedin.com/in/matthew-silverman-a84382105/" target="_blank" rel="noopener noreferrer">LinkedIn</a> ¬∑
                        <a href="https://buymeacoffee.com/msilverman" target="_blank" rel="noopener noreferrer">Buy me a coffee</a>
                    </p>
                </section>
            </div>
        </div>

        <!-- Export Season Modal -->
        <div class="export-modal-overlay" id="exportModalOverlay"></div>
        <div class="export-modal" id="exportModal">
            <div class="export-modal-header">Export Data</div>

            <div class="export-form-group">
                <label class="export-label" for="exportSportSelect">Sport</label>
                <select class="export-select" id="exportSportSelect">
                    <option value="NFL">NFL</option>
                    <option value="CFB">CFB</option>
                    <option value="NBA">NBA</option>
                </select>
            </div>

            <div class="export-form-group">
                <label class="export-label" for="exportSeasonSelect">Season</label>
                <select class="export-select" id="exportSeasonSelect">
                    <!-- Options populated by JavaScript -->
                </select>
            </div>

            <div class="export-form-group" id="weekRangeGroup">
                <label class="export-label">Weeks</label>
                <div class="export-presets" id="exportPresets">
                    <!-- Preset buttons populated by JavaScript -->
                </div>
                <div class="export-custom-range" id="exportCustomRange" style="display: none;">
                    <div class="export-range-inputs">
                        <select class="export-range-select" id="exportStartWeek">
                            <!-- Options populated by JavaScript -->
                        </select>
                        <span class="export-range-separator">to</span>
                        <select class="export-range-select" id="exportEndWeek">
                            <!-- Options populated by JavaScript -->
                        </select>
                    </div>
                </div>
            </div>

            <div class="export-form-group" id="dateRangeGroup" style="display: none;">
                <label class="export-label">Dates</label>
                <div class="export-presets" id="exportDatePresets">
                    <!-- Preset buttons populated by JavaScript -->
                </div>
                <div class="export-custom-range" id="exportCustomDateRange" style="display: none;">
                    <div class="export-range-inputs">
                        <input type="date" class="export-date-input" id="exportStartDate">
                        <span class="export-range-separator">to</span>
                        <input type="date" class="export-date-input" id="exportEndDate">
                    </div>
                </div>
            </div>

            <div class="export-validation-message" id="exportValidationMessage" style="display: none;"></div>

            <div class="export-progress" id="exportProgress">
                <div class="export-progress-text" id="exportProgressText">Fetching week 1 of 18...</div>
                <div class="export-progress-bar">
                    <div class="export-progress-fill" id="exportProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="export-warning" id="exportWarning" style="display: none;">
                Note: NBA exports may take 1-2 minutes due to the larger number of games.
            </div>

            <div class="export-actions">
                <button class="export-btn" id="exportCancelBtn">Cancel</button>
                <button class="export-btn primary" id="exportDownloadBtn">Download</button>
            </div>
        </div>
    </div>

    <!-- JavaScript modules -->
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>

    <script>
        // Get current week for a sport based on date
        function getCurrentWeek(sport) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-indexed

            if (sport === 'NFL') {
                // NFL season runs September - February
                // Week 1 starts the Thursday after Labor Day (first Monday in September)
                // 2024 season: Started Sept 5, 2024
                // 2025 season: Started Sept 4, 2025

                let season;
                let seasonStart;

                // Try current year's season first
                season = year;
                seasonStart = new Date(year, 8, 1); // Sept 1

                // Find first Monday in September (Labor Day)
                while (seasonStart.getDay() !== 1) {
                    seasonStart.setDate(seasonStart.getDate() + 1);
                }

                // First Thursday after Labor Day (add 3 days)
                seasonStart.setDate(seasonStart.getDate() + 3);

                // If we're before this season's start, use previous year's season
                if (now < seasonStart) {
                    season = year - 1;
                    seasonStart = new Date(season, 8, 1); // Sept 1 of previous year
                    while (seasonStart.getDay() !== 1) {
                        seasonStart.setDate(seasonStart.getDate() + 1);
                    }
                    seasonStart.setDate(seasonStart.getDate() + 3);
                }

                // Calculate weeks since season start
                const daysSinceStart = Math.floor((now - seasonStart) / (24 * 60 * 60 * 1000));
                let week = Math.floor(daysSinceStart / 7) + 1;

                // Cap at week 18
                week = Math.min(18, Math.max(1, week));
                return { season: season, week: week };

            } else if (sport === 'CFB') {
                // CFB season runs late August - early January
                // Week 0/1 typically starts last week of August
                // 2024 season: Started Aug 24, 2024
                // 2025 season: Started Aug 30, 2025

                let season;
                let seasonStart;

                // Try current year's season first
                season = year;
                seasonStart = new Date(year, 7, 24); // Aug 24 (roughly last week of August)

                // If we're before this season's start, use previous year's season
                if (now < seasonStart) {
                    season = year - 1;
                    seasonStart = new Date(season, 7, 24); // Aug 24 of previous year
                }

                // Calculate weeks since season start
                const daysSinceStart = Math.floor((now - seasonStart) / (24 * 60 * 60 * 1000));
                let week = Math.floor(daysSinceStart / 7) + 1;

                // Cap at week 15 (regular season)
                week = Math.min(15, Math.max(1, week));
                return { season: season, week: week };
            }

            return { season: year, week: 1 };
        }

        // Legacy function for backwards compatibility
        function getCurrentNFLWeek() {
            return getCurrentWeek('NFL');
        }

        // State
        const currentNFLWeek = getCurrentNFLWeek();
        let selectedSport = 'NFL';
        let selectedSeason = currentNFLWeek.season;
        let selectedWeek = currentNFLWeek.week;
        let selectedDate = null; // For NBA date-based navigation
        let spoilerFree = localStorage.getItem('spoilerFree') !== 'false';
        let currentGames = null;
        let isLoading = false;
        let isInitialLoad = true; // Track if this is the first load to enable auto-fallback

        // Theme state
        let currentTheme = localStorage.getItem('theme') || 'dark';

        // Team lookup state
        let viewMode = 'week'; // 'week' | 'schedule' | 'single-game'
        let selectedTeam = null;
        let selectedGameFromSchedule = null;
        let allTeams = [];
        let currentSchedule = null;

        // Initialize
        async function init() {
            // Initialize Supabase (async, won't block UI)
            if (typeof initSupabase === 'function') {
                initSupabase(); // Fire and forget
            }

            updateThemeToggleText();
            attachEventListeners();
            updateUI();
            loadGames();
        }

        // Theme Toggle Functions
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeToggleText();
        }

        function updateThemeToggleText() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = currentTheme === 'dark' ? 'light' : 'dark';
            }
        }

        // Update UI elements
        function updateUI() {
            // Update header week info
            const now = new Date();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            if (selectedSport === 'NBA') {
                const dateObj = selectedDate ? new Date(selectedDate) : new Date(now.getTime() - 24*60*60*1000);
                document.getElementById('headerWeekInfo').textContent =
                    `${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
            } else {
                if (selectedWeek === 'bowls') {
                    document.getElementById('headerWeekInfo').textContent =
                        `Bowl Season ¬∑ ${monthNames[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
                } else {
                    document.getElementById('headerWeekInfo').textContent =
                        `Week ${selectedWeek} ¬∑ ${monthNames[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
                }
            }

            // Update sport selector
            document.getElementById('nflOption').classList.toggle('active', selectedSport === 'NFL');
            document.getElementById('cfbOption').classList.toggle('active', selectedSport === 'CFB');
            document.getElementById('nbaOption').classList.toggle('active', selectedSport === 'NBA');

            // Show/hide appropriate navigation
            if (selectedSport === 'NBA') {
                document.getElementById('weekSelector').style.display = 'none';
                document.getElementById('dateSelector').style.display = 'block';
                updateDateNavigation();
            } else {
                document.getElementById('weekSelector').style.display = 'block';
                document.getElementById('dateSelector').style.display = 'none';
                updateWeekNavigation();
            }
        }

        // Update week-based navigation (NFL/CFB)
        function updateWeekNavigation() {
            // Update week display
            if (selectedWeek === 'bowls') {
                document.getElementById('currentWeekDisplay').textContent =
                    `${selectedSeason} ¬∑ bowls`;
            } else {
                document.getElementById('currentWeekDisplay').textContent =
                    `${selectedSeason} ¬∑ week ${selectedWeek}`;
            }

            // Update prev/next week numbers
            const maxWeeks = selectedSport === 'NFL' ? 18 : 15;
            const prevWeekLink = document.getElementById('prevWeek');
            const nextWeekLink = document.getElementById('nextWeek');

            // Handle navigation for bowls
            if (selectedWeek === 'bowls') {
                // Previous from bowls is week 15 for CFB
                document.getElementById('prevWeekNum').textContent = maxWeeks;
                prevWeekLink.style.display = 'inline';
                nextWeekLink.style.display = 'none';
            } else {
                const prevWeekNum = selectedWeek > 1 ? selectedWeek - 1 : null;
                let nextWeekNum;

                // For CFB at week 15, next is "bowls"
                if (selectedSport === 'CFB' && selectedWeek === maxWeeks) {
                    nextWeekNum = 'bowls';
                } else if (selectedWeek < maxWeeks) {
                    nextWeekNum = selectedWeek + 1;
                } else {
                    nextWeekNum = null;
                }

                if (prevWeekNum) {
                    document.getElementById('prevWeekNum').textContent = prevWeekNum;
                    prevWeekLink.style.display = 'inline';
                } else {
                    prevWeekLink.style.display = 'none';
                }

                if (nextWeekNum) {
                    if (nextWeekNum === 'bowls') {
                        document.getElementById('nextWeekNum').textContent = 'bowls';
                    } else {
                        document.getElementById('nextWeekNum').textContent = nextWeekNum;
                    }
                    nextWeekLink.style.display = 'inline';
                } else {
                    nextWeekLink.style.display = 'none';
                }
            }
        }

        // Update date-based navigation (NBA)
        function updateDateNavigation() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const currentDate = selectedDate ? new Date(selectedDate) : new Date(today.getTime() - 24*60*60*1000);

            // Format display date
            const monthShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const yesterday = new Date(today.getTime() - 24*60*60*1000);
            const twoDaysAgo = new Date(today.getTime() - 2*24*60*60*1000);

            // Update current date display
            let currentDisplayText;
            if (currentDate.getTime() === today.getTime()) {
                currentDisplayText = 'today';
            } else if (currentDate.getTime() === yesterday.getTime()) {
                currentDisplayText = 'yesterday';
            } else if (currentDate.getTime() === twoDaysAgo.getTime()) {
                currentDisplayText = '2 days ago';
            } else {
                currentDisplayText = `${monthShort[currentDate.getMonth()]} ${currentDate.getDate()}`;
            }
            document.getElementById('currentDateDisplay').textContent = currentDisplayText;

            // Calculate prev/next dates
            const prevDate = new Date(currentDate.getTime() - 24*60*60*1000);
            const nextDate = new Date(currentDate.getTime() + 24*60*60*1000);

            // Update prev date
            let prevDisplayText;
            if (prevDate.getTime() === yesterday.getTime()) {
                prevDisplayText = 'yesterday';
            } else if (prevDate.getTime() === twoDaysAgo.getTime()) {
                prevDisplayText = '2 days ago';
            } else {
                prevDisplayText = `${monthShort[prevDate.getMonth()]} ${prevDate.getDate()}`;
            }
            document.getElementById('prevDateDisplay').textContent = prevDisplayText;

            // Update next date (only show if before or equal to today)
            const prevDateLink = document.getElementById('prevDate');
            const nextDateLink = document.getElementById('nextDate');

            if (nextDate <= today) {
                let nextDisplayText;
                if (nextDate.getTime() === today.getTime()) {
                    nextDisplayText = 'today';
                } else if (nextDate.getTime() === yesterday.getTime()) {
                    nextDisplayText = 'yesterday';
                } else {
                    nextDisplayText = `${monthShort[nextDate.getMonth()]} ${nextDate.getDate()}`;
                }
                document.getElementById('nextDateDisplay').textContent = nextDisplayText;
                nextDateLink.style.display = 'inline';
            } else {
                nextDateLink.style.display = 'none';
            }
        }

        // Attach event listeners
        function attachEventListeners() {
            // Sport selector
            document.getElementById('nflOption').addEventListener('click', () => {
                if (selectedSport !== 'NFL') {
                    selectedSport = 'NFL';
                    const currentWeek = getCurrentWeek('NFL');
                    selectedSeason = currentWeek.season;
                    selectedWeek = currentWeek.week;
                    // Reset team lookup state
                    allTeams = [];
                    viewMode = 'week';
                    selectedTeam = null;
                    isInitialLoad = true; // Allow fallback for sport switch
                    updateUI();
                    loadGames();
                }
            });

            document.getElementById('cfbOption').addEventListener('click', () => {
                if (selectedSport !== 'CFB') {
                    selectedSport = 'CFB';
                    const currentWeek = getCurrentWeek('CFB');
                    selectedSeason = currentWeek.season;
                    selectedWeek = currentWeek.week;
                    // Reset team lookup state
                    allTeams = [];
                    viewMode = 'week';
                    selectedTeam = null;
                    isInitialLoad = true; // Allow fallback for sport switch
                    updateUI();
                    loadGames();
                }
            });

            document.getElementById('nbaOption').addEventListener('click', () => {
                if (selectedSport !== 'NBA') {
                    selectedSport = 'NBA';
                    // Default to yesterday for NBA (most recent completed games)
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    selectedDate = yesterday.toISOString().split('T')[0];
                    // Reset date picker state
                    pickerMonth = null;
                    pickerYear = null;
                    // Reset team lookup state
                    allTeams = [];
                    viewMode = 'week';
                    selectedTeam = null;
                    isInitialLoad = true; // Allow fallback for sport switch
                    updateUI();
                    loadGames();
                }
            });

            // Week navigation (NFL/CFB)
            document.getElementById('prevWeek').addEventListener('click', (e) => {
                e.preventDefault();
                const maxWeeks = selectedSport === 'NFL' ? 18 : 15;

                if (selectedWeek === 'bowls') {
                    // Previous from bowls is week 15 for CFB
                    selectedWeek = maxWeeks;
                    isInitialLoad = false; // User manually navigated
                    updateUI();
                    loadGames();
                } else if (selectedWeek > 1) {
                    selectedWeek--;
                    isInitialLoad = false; // User manually navigated
                    updateUI();
                    loadGames();
                }
            });

            document.getElementById('nextWeek').addEventListener('click', (e) => {
                e.preventDefault();
                const maxWeeks = selectedSport === 'NFL' ? 18 : 15;

                if (selectedSport === 'CFB' && selectedWeek === maxWeeks) {
                    // Next from week 15 is bowls for CFB
                    selectedWeek = 'bowls';
                    isInitialLoad = false; // User manually navigated
                    updateUI();
                    loadGames();
                } else if (selectedWeek < maxWeeks && selectedWeek !== 'bowls') {
                    selectedWeek++;
                    isInitialLoad = false; // User manually navigated
                    updateUI();
                    loadGames();
                }
            });

            // Date navigation (NBA)
            document.getElementById('prevDate').addEventListener('click', (e) => {
                e.preventDefault();
                const currentDate = selectedDate ? new Date(selectedDate) : new Date(new Date().getTime() - 24*60*60*1000);
                const prevDate = new Date(currentDate.getTime() - 24*60*60*1000);
                selectedDate = prevDate.toISOString().split('T')[0];
                isInitialLoad = false; // User manually navigated
                updateUI();
                loadGames();
            });

            document.getElementById('nextDate').addEventListener('click', (e) => {
                e.preventDefault();
                const currentDate = selectedDate ? new Date(selectedDate) : new Date(new Date().getTime() - 24*60*60*1000);
                const nextDate = new Date(currentDate.getTime() + 24*60*60*1000);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (nextDate <= today) {
                    selectedDate = nextDate.toISOString().split('T')[0];
                    isInitialLoad = false; // User manually navigated
                    updateUI();
                    loadGames();
                }
            });

            // Custom date picker toggle (NBA)
            document.getElementById('currentDateDisplay').addEventListener('click', (e) => {
                if (selectedSport === 'NBA') {
                    e.stopPropagation();
                    const picker = document.getElementById('customDatePicker');
                    const isVisible = picker.classList.contains('visible');

                    if (!isVisible) {
                        populateCustomDatePicker();
                        picker.classList.add('visible');
                    } else {
                        picker.classList.remove('visible');
                    }
                }
            });

            // Close custom date picker when clicking outside
            document.addEventListener('click', (e) => {
                const picker = document.getElementById('customDatePicker');
                const currentDateDisplay = document.getElementById('currentDateDisplay');

                if (selectedSport === 'NBA' && !picker.contains(e.target) && e.target !== currentDateDisplay) {
                    picker.classList.remove('visible');
                }
            });

            // About link
            document.getElementById('aboutLink').addEventListener('click', (e) => {
                e.preventDefault();
                const mainContent = document.getElementById('mainContent');
                const aboutContent = document.getElementById('aboutContent');

                if (aboutContent.classList.contains('hidden')) {
                    mainContent.classList.add('hidden');
                    aboutContent.classList.remove('hidden');
                    e.target.textContent = 'home';
                } else {
                    aboutContent.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    e.target.textContent = 'about';
                }
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', (e) => {
                e.preventDefault();
                toggleTheme();
            });

            // Week picker toggle
            document.getElementById('currentWeekDisplay').addEventListener('click', (e) => {
                e.stopPropagation();
                const picker = document.getElementById('weekPicker');
                const isVisible = picker.classList.contains('visible');

                if (!isVisible) {
                    populateWeekPicker();
                    picker.classList.add('visible');
                } else {
                    picker.classList.remove('visible');
                }
            });

            // Close week picker when clicking outside
            document.addEventListener('click', (e) => {
                const picker = document.getElementById('weekPicker');
                const currentWeekDisplay = document.getElementById('currentWeekDisplay');

                if (!picker.contains(e.target) && e.target !== currentWeekDisplay) {
                    picker.classList.remove('visible');
                }
            });

            // Team lookup - Find a game link
            document.getElementById('findGameLink').addEventListener('click', (e) => {
                e.stopPropagation();
                const picker = document.getElementById('teamPicker');
                const isVisible = picker.classList.contains('visible');

                if (!isVisible) {
                    loadTeams();
                    picker.classList.add('visible');
                    document.getElementById('teamSearchInput').focus();
                } else {
                    picker.classList.remove('visible');
                }
            });

            // Team search input
            document.getElementById('teamSearchInput').addEventListener('input', (e) => {
                filterTeams(e.target.value);
            });

            // Close team picker when clicking outside
            document.addEventListener('click', (e) => {
                const picker = document.getElementById('teamPicker');
                const findGameLink = document.getElementById('findGameLink');

                if (!picker.contains(e.target) && e.target !== findGameLink) {
                    picker.classList.remove('visible');
                }
            });
        }

        // Populate custom date picker
        let pickerMonth, pickerYear;

        function populateCustomDatePicker() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const currentDate = selectedDate ? new Date(selectedDate) : new Date(today.getTime() - 24*60*60*1000);

            // Initialize picker to current selected date's month
            if (!pickerMonth && !pickerYear) {
                pickerMonth = currentDate.getMonth();
                pickerYear = currentDate.getFullYear();
            }

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            // Update month/year display
            document.getElementById('pickerMonthYear').textContent = `${monthNames[pickerMonth]} ${pickerYear}`;

            // Setup month navigation
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');

            prevMonthBtn.onclick = (e) => {
                e.stopPropagation();
                pickerMonth--;
                if (pickerMonth < 0) {
                    pickerMonth = 11;
                    pickerYear--;
                }
                populateCustomDatePicker();
            };

            nextMonthBtn.onclick = (e) => {
                e.stopPropagation();
                pickerMonth++;
                if (pickerMonth > 11) {
                    pickerMonth = 0;
                    pickerYear++;
                }
                populateCustomDatePicker();
            };

            // Build calendar grid
            const firstDay = new Date(pickerYear, pickerMonth, 1);
            const lastDay = new Date(pickerYear, pickerMonth + 1, 0);
            const prevMonthLastDay = new Date(pickerYear, pickerMonth, 0);

            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
            const daysInMonth = lastDay.getDate();
            const daysInPrevMonth = prevMonthLastDay.getDate();

            const dateGrid = document.getElementById('dateGrid');

            // Remove all existing date cells (keep headers)
            const headers = Array.from(dateGrid.querySelectorAll('.date-grid-header'));
            dateGrid.innerHTML = '';
            headers.forEach(header => dateGrid.appendChild(header));

            // Add previous month's trailing days
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const cell = document.createElement('div');
                cell.className = 'date-item other-month';
                cell.textContent = day;
                dateGrid.appendChild(cell);
            }

            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'date-item';
                cell.textContent = day;

                const cellDate = new Date(pickerYear, pickerMonth, day);

                // Disable future dates
                if (cellDate > today) {
                    cell.classList.add('disabled');
                } else {
                    // Check if this is the selected date
                    const cellDateStr = cellDate.toISOString().split('T')[0];
                    const selectedDateStr = selectedDate || new Date(today.getTime() - 24*60*60*1000).toISOString().split('T')[0];

                    if (cellDateStr === selectedDateStr) {
                        cell.classList.add('selected');
                    }

                    cell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectedDate = cellDateStr;
                        isInitialLoad = false; // User manually selected date
                        document.getElementById('customDatePicker').classList.remove('visible');
                        updateUI();
                        loadGames();
                    });
                }

                dateGrid.appendChild(cell);
            }

            // Add next month's leading days to complete the grid
            // Count only date-item cells (not headers)
            const dateCells = dateGrid.querySelectorAll('.date-item').length;
            const remainingCells = (Math.ceil(dateCells / 7) * 7) - dateCells;

            for (let day = 1; day <= remainingCells; day++) {
                const cell = document.createElement('div');
                cell.className = 'date-item other-month';
                cell.textContent = day;
                dateGrid.appendChild(cell);
            }
        }

        // Populate week picker dropdown
        function populateWeekPicker() {
            const currentYear = new Date().getFullYear();
            const maxWeeks = selectedSport === 'NFL' ? 18 : 15;

            // Determine current season for the selected sport
            const currentSeasonInfo = getCurrentWeek(selectedSport);
            const currentSeasonYear = currentSeasonInfo.season;

            // Populate season buttons
            // Only show current season (historical data not available)
            const seasonButtons = document.getElementById('seasonButtons');
            seasonButtons.innerHTML = '';

            const seasonsToShow = [currentSeasonYear];

            seasonsToShow.forEach(year => {
                const btn = document.createElement('div');
                btn.className = 'season-btn';
                if (year === selectedSeason) {
                    btn.classList.add('active');
                }
                btn.textContent = year;
                btn.addEventListener('click', () => {
                    selectedSeason = year;
                    selectedWeek = 1; // Reset to week 1 when changing season
                    isInitialLoad = false; // User manually selected season
                    updateUI();
                    loadGames();
                    document.getElementById('weekPicker').classList.remove('visible');
                });
                seasonButtons.appendChild(btn);
            });

            // Populate week grid
            const weekGrid = document.getElementById('weekGrid');
            weekGrid.innerHTML = '';

            for (let week = 1; week <= maxWeeks; week++) {
                const weekItem = document.createElement('div');
                weekItem.className = 'week-item';
                if (week === selectedWeek) {
                    weekItem.classList.add('selected');
                }
                weekItem.textContent = week;
                weekItem.addEventListener('click', () => {
                    selectedWeek = week;
                    isInitialLoad = false; // User manually selected week
                    updateUI();
                    loadGames();
                    document.getElementById('weekPicker').classList.remove('visible');
                });
                weekGrid.appendChild(weekItem);
            }

            // Add "Bowls" option for CFB
            if (selectedSport === 'CFB') {
                const bowlsItem = document.createElement('div');
                bowlsItem.className = 'week-item';
                if (selectedWeek === 'bowls') {
                    bowlsItem.classList.add('selected');
                }
                bowlsItem.textContent = 'Bowls';
                bowlsItem.addEventListener('click', () => {
                    selectedWeek = 'bowls';
                    isInitialLoad = false; // User manually selected bowls
                    updateUI();
                    loadGames();
                    document.getElementById('weekPicker').classList.remove('visible');
                });
                weekGrid.appendChild(bowlsItem);
            }
        }

        // Helper: Determine if static file should be used for this request
        function shouldUseStatic(sport, season, weekOrDate) {
            // Don't use static files for current/future weeks
            // Use 24-hour buffer to ensure games are completed
            const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

            if (sport === 'NBA') {
                // For NBA, check if the date is at least 1 day ago
                const gameDate = new Date(weekOrDate);
                console.log(`üîç shouldUseStatic check - gameDate: ${gameDate.toISOString()}, oneDayAgo: ${oneDayAgo.toISOString()}, result: ${gameDate <= oneDayAgo}`);
                return gameDate <= oneDayAgo;
            } else {
                // For NFL/CFB, use week end dates
                const weekEndDate = getWeekEndDate(sport, season, weekOrDate);
                return weekEndDate <= oneDayAgo;
            }
        }

        // Helper: Get the end date for a given week
        function getWeekEndDate(sport, season, week) {
            // This is a simplified version - actual week end dates vary
            // For production, you may want to use more precise dates
            const now = new Date();

            // If requesting current season and current/future week, assume not completed
            if (season >= now.getFullYear()) {
                // Return far future date to force API call for current season
                return new Date('2099-12-31');
            }

            // For past seasons, assume all weeks are completed
            return new Date(season, 11, 31); // End of season year
        }

        // Helper: Get static file path
        function getStaticPath(sport, season, weekOrDate) {
            const sportLower = sport.toLowerCase();
            if (sport === 'NBA') {
                return `/data/${sportLower}/${season}/${weekOrDate}.json`;
            }
            const weekStr = weekOrDate === 'bowls' ? 'bowls' : `week-${String(weekOrDate).padStart(2, '0')}`;
            return `/data/${sportLower}/${season}/${weekStr}.json`;
        }

        // Helper: Fetch from static file
        async function fetchStaticData(sport, season, weekOrDate) {
            try {
                const path = getStaticPath(sport, season, weekOrDate);
                const response = await fetch(path);

                if (!response.ok) {
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                return null;
            }
        }

        // Load games
        async function loadGames(fallbackAttempt = 0) {
            if (isLoading) return;
            isLoading = true;
            showLoading();

            const MAX_FALLBACK_ATTEMPTS = 3;

            console.log(`üîç loadGames() called - Sport: ${selectedSport}, Week: ${selectedWeek}, Date: ${selectedDate}, isInitialLoad: ${isInitialLoad}, fallbackAttempt: ${fallbackAttempt}`);

            try {
                // Try to load from static file first
                const weekOrDate = selectedSport === 'NBA' ? selectedDate : selectedWeek;
                console.log(`üìÇ Checking static file - weekOrDate: ${weekOrDate}`);
                if (shouldUseStatic(selectedSport, selectedSeason, weekOrDate)) {
                    const staticData = await fetchStaticData(selectedSport, selectedSeason, weekOrDate);
                    console.log(`üìÇ Static data result:`, staticData ? `success=${staticData.success}, games=${staticData.games?.length || 0}` : 'null');
                    if (staticData && staticData.success && staticData.games && staticData.games.length > 0) {
                        console.log('‚úÖ Loaded from static file:', getStaticPath(selectedSport, selectedSeason, weekOrDate));
                        console.log('üìä All games from static file:', staticData.games.map(g => `${g.homeTeam} v ${g.awayTeam}`));
                        currentGames = staticData.games;
                        console.log('üìä currentGames set to:', currentGames.length, 'games');
                        displayResults();
                        isLoading = false;
                        isInitialLoad = false;
                        return;
                    }
                    console.log('‚ö†Ô∏è Static file not found or empty, falling back to API');
                } else {
                    console.log('‚ùå shouldUseStatic returned false, using API instead');
                }

                // Fall back to API
                let requestBody;
                if (selectedSport === 'NBA') {
                    requestBody = {
                        sport: selectedSport,
                        date: selectedDate
                    };
                } else {
                    requestBody = {
                        sport: selectedSport,
                        season: selectedSeason,
                        week: selectedWeek,
                        seasonType: '2'
                    };
                }

                console.log('üåê Loading from API...');
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log(`üåê API response:`, data ? `success=${data.success}, games=${data.games?.length || 0}` : 'null');

                if (data.success && data.games && data.games.length > 0) {
                    console.log(`‚úÖ Loaded ${data.games.length} games from API`);
                    currentGames = data.games;
                    displayResults();
                    isInitialLoad = false;
                } else {
                    console.log(`‚ùå No games found - isInitialLoad: ${isInitialLoad}, fallbackAttempt: ${fallbackAttempt}/${MAX_FALLBACK_ATTEMPTS}`);

                    // No games found - check if we should auto-fallback
                    if (isInitialLoad && fallbackAttempt < MAX_FALLBACK_ATTEMPTS) {
                        let canFallback = false;

                        if (selectedSport === 'NBA') {
                            // For NBA, try previous date
                            console.log(`üîÑ NBA fallback - current date: ${selectedDate}`);
                            const currentDate = selectedDate ? new Date(selectedDate) : new Date(new Date().getTime() - 24*60*60*1000);
                            const prevDate = new Date(currentDate.getTime() - 24*60*60*1000);
                            const newDate = prevDate.toISOString().split('T')[0];
                            console.log(`üìÖ NBA fallback: ${selectedDate} ‚Üí ${newDate}`);
                            selectedDate = newDate;
                            canFallback = true;
                        } else {
                            // For NFL/CFB, try previous week
                            console.log(`üîÑ ${selectedSport} fallback - current week: ${selectedWeek}`);
                            if (selectedWeek === 'bowls') {
                                const maxWeeks = selectedSport === 'NFL' ? 18 : 15;
                                console.log(`üìÖ Bowls fallback: bowls ‚Üí week ${maxWeeks}`);
                                selectedWeek = maxWeeks;
                                canFallback = true;
                            } else if (selectedWeek > 1) {
                                console.log(`üìÖ Week fallback: week ${selectedWeek} ‚Üí week ${selectedWeek - 1}`);
                                selectedWeek--;
                                canFallback = true;
                            } else {
                                console.log(`‚ö†Ô∏è Cannot fallback - already at week 1`);
                            }
                        }

                        if (canFallback) {
                            console.log(`üîÑ Retrying with fallback attempt ${fallbackAttempt + 1}`);
                            isLoading = false;
                            updateUI();
                            return loadGames(fallbackAttempt + 1);
                        } else {
                            console.log(`‚õî No fallback available`);
                        }
                    } else {
                        console.log(`‚õî Fallback disabled - isInitialLoad: ${isInitialLoad}, attempts: ${fallbackAttempt}/${MAX_FALLBACK_ATTEMPTS}`);
                    }

                    // No fallback or max attempts reached
                    isInitialLoad = false;
                    showEmpty();
                }
            } catch (error) {
                console.error('Error:', error);
                isInitialLoad = false;
                showEmpty('Could not load games. Please try again.');
            } finally {
                isLoading = false;
            }
        }

        // Show loading state
        function showLoading(customMessage = null) {
            const resultsArea = document.getElementById('resultsArea');
            let loadingMessage = customMessage;

            if (!loadingMessage) {
                if (selectedSport === 'NBA') {
                    const dateObj = selectedDate ? new Date(selectedDate) : new Date(new Date().getTime() - 24*60*60*1000);
                    const monthShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    loadingMessage = `loading ${monthShort[dateObj.getMonth()]} ${dateObj.getDate()}...`;
                } else if (selectedWeek === 'bowls') {
                    loadingMessage = `loading bowl games...`;
                } else {
                    loadingMessage = `loading week ${selectedWeek}...`;
                }
            }

            resultsArea.innerHTML = `
                <div class="loading">
                    <div class="loading-text">${loadingMessage}</div>
                </div>
            `;
        }

        // Show empty state
        function showEmpty(message = null) {
            if (!message) {
                if (selectedSport === 'NBA') {
                    const dateObj = selectedDate ? new Date(selectedDate) : new Date(new Date().getTime() - 24*60*60*1000);
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
                    message = `No games found for ${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}.`;
                } else if (selectedWeek === 'bowls') {
                    message = `No completed bowl games yet for the ${selectedSeason} season.`;
                } else {
                    message = `No games found for Week ${selectedWeek}, ${selectedSeason}.`;
                }
            }
            const resultsArea = document.getElementById('resultsArea');
            resultsArea.innerHTML = `
                <div class="empty-state">
                    <div class="empty-message">${message}</div>
                </div>
            `;
        }

        // Display results
        function displayResults() {
            console.log('üéØ displayResults() called with currentGames:', currentGames?.length || 'null/undefined');
            if (!currentGames) return;

            // Sort by excitement score
            const sortedGames = [...currentGames].sort((a, b) => (b.excitement || 0) - (a.excitement || 0));
            console.log('üéØ sortedGames length:', sortedGames.length);

            // Calculate statistics
            const stats = {
                mustWatch: sortedGames.filter(g => (g.excitement || 0) >= 8).length,
                recommended: sortedGames.filter(g => (g.excitement || 0) >= 6 && (g.excitement || 0) < 8).length,
                skip: sortedGames.filter(g => (g.excitement || 0) < 6).length
            };

            // Build HTML
            let html = '';

            // Statistics line
            html += `<div class="statistics-line">
                <span class="stat-number">${stats.mustWatch}</span> must watch ¬∑
                <span class="stat-number">${stats.recommended}</span> recommended ¬∑
                <span class="stat-number">${stats.skip}</span> skip
            </div>`;

            // Toggle slider for scores
            html += `
                <div class="spoiler-toggle-wrapper">
                    <span class="toggle-label">show scores</span>
                    <div class="toggle-switch ${!spoilerFree ? 'active' : ''}" id="scoreToggle">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            `;

            // Games list
            html += '<div class="games-list">';
            sortedGames.forEach((game, index) => {
                html += createGameRow(game, index);
            });
            html += '</div>';

            document.getElementById('resultsArea').innerHTML = html;

            // Attach event listeners
            attachScoreToggleListener();
            attachRadarChartListeners();
            attachVoteListeners();
        }

        // Render radar chart for metric breakdown
        function renderRadarChart(breakdown) {
            // Handle missing or empty breakdown data
            if (!breakdown || Object.keys(breakdown).length === 0) {
                return '<div style="color: #6b6560; font-size: 11px; padding: 8px;">Breakdown data not available for this game. Try selecting a different week to load fresh data.</div>';
            }

            const metrics = [
                { key: 'uncertainty', label: 'Uncertainty', desc: 'How long was the outcome in doubt? Games that stayed close to 50/50 score highest.' },
                { key: 'drama', label: 'Drama', desc: 'Magnitude of momentum swings when the game was close. Leverage-weighted for maximum impact.' },
                { key: 'finish', label: 'Finish', desc: 'How exciting were the final minutes? Combines late-game volatility, closeness, and walk-off moments.' }
            ];

            const size = 330;
            const center = size / 2;
            const radius = 80;
            const labelDistance = 130;
            const angleStep = (2 * Math.PI) / 3;
            const startAngle = -Math.PI / 2; // Start at top

            // Calculate vertex positions for max (10) and actual values
            const points = metrics.map((m, i) => {
                const angle = startAngle + (i * angleStep);
                const value = breakdown[m.key] || 0;
                const r = (value / 10) * radius;
                return {
                    x: center + r * Math.cos(angle),
                    y: center + r * Math.sin(angle),
                    labelX: center + labelDistance * Math.cos(angle),
                    labelY: center + labelDistance * Math.sin(angle),
                    label: m.label,
                    value: value
                };
            });

            // Build SVG
            const polygonPoints = points.map(p => `${p.x},${p.y}`).join(' ');

            // Grid lines (circles at 2, 4, 6, 8, 10)
            let gridLines = '';
            for (let level = 2; level <= 10; level += 2) {
                const r = (level / 10) * radius;
                gridLines += `<circle cx="${center}" cy="${center}" r="${r}" class="radar-grid"/>`;
            }

            // Axis lines
            let axisLines = '';
            points.forEach((p, i) => {
                const angle = startAngle + (i * angleStep);
                const endX = center + radius * Math.cos(angle);
                const endY = center + radius * Math.sin(angle);
                axisLines += `<line x1="${center}" y1="${center}" x2="${endX}" y2="${endY}" class="radar-axis"/>`;
            });

            // Labels with hover tooltips
            let labels = '';
            points.forEach((p, i) => {
                labels += `
                    <g class="radar-label-group" data-metric="${metrics[i].key}" data-desc="${metrics[i].desc}">
                        <text x="${p.labelX}" y="${p.labelY}" class="radar-label">${p.label}</text>
                        <text x="${p.labelX}" y="${p.labelY + 14}" class="radar-value">${p.value.toFixed(1)}</text>
                    </g>
                `;
            });

            return `
                <div style="position: relative;">
                    <svg width="${size}" height="${size}" class="radar-chart" viewBox="0 0 ${size} ${size}">
                        ${gridLines}
                        ${axisLines}
                        <polygon points="${polygonPoints}" class="radar-fill"/>
                        ${labels}
                    </svg>
                    <div class="metric-tooltip" id="metric-tooltip"></div>
                </div>
            `;
        }

        // Create game row HTML
        function createGameRow(game, index) {
            const score = game.excitement || 0;
            let ratingClass, ratingText;

            if (score >= 8) {
                ratingClass = 'must-watch';
                ratingText = 'must watch';
            } else if (score >= 6) {
                ratingClass = 'recommended';
                ratingText = 'recommended';
            } else {
                ratingClass = 'skip';
                ratingText = 'skip';
            }

            const shouldShowGameScore = !spoilerFree;

            // Format scores
            const displayScore = score % 1 === 0 ? score : score.toFixed(1);
            const gameScoreText = `${game.awayScore || 0}-${game.homeScore || 0}${game.overtime ? ' OT' : ''}`;

            // Calculate pie chart values
            const radius = 21;
            const circumference = 2 * Math.PI * radius;
            const progress = (score / 10) * circumference;
            const remaining = circumference - progress;

            // Generate ESPN recap URL
            let sportPath;
            if (selectedSport === 'NFL') {
                sportPath = 'nfl';
            } else if (selectedSport === 'CFB') {
                sportPath = 'college-football';
            } else if (selectedSport === 'NBA') {
                sportPath = 'nba';
            }
            const recapUrl = `https://www.espn.com/${sportPath}/game/_/gameId/${game.id}`;

            // Build bowl/playoff info for CFB postseason
            let bowlInfo = '';
            if (selectedSport === 'CFB' && (game.bowlName || game.playoffRound)) {
                if (game.playoffRound) {
                    bowlInfo = `<div class="bowl-info playoff">${game.bowlName ? game.bowlName + ' ¬∑ ' : ''}CFP ${game.playoffRound}</div>`;
                } else if (game.bowlName) {
                    bowlInfo = `<div class="bowl-info">${game.bowlName}</div>`;
                }
            }

            return `
                <div class="game-row" data-game-index="${index}">
                    ${bowlInfo}
                    <div class="score-rating-line ${ratingClass}">
                        <span class="score-value">${displayScore}</span>
                        <span class="score-separator"> ¬∑ </span>
                        <span class="rating-text">${ratingText}</span>
                    </div>
                    <div class="matchup-wrapper">
                        <div class="score-pie">
                            <svg width="48" height="48" viewBox="0 0 48 48">
                                <circle class="score-pie-bg" cx="24" cy="24" r="${radius}"/>
                                <circle class="score-pie-fill ${ratingClass}"
                                        cx="24" cy="24" r="${radius}"
                                        stroke-dasharray="${progress} ${remaining}"/>
                            </svg>
                            <div class="score-pie-value">${displayScore}</div>
                        </div>
                        <div class="matchup">
                            ${game.awayTeam} <span class="vs-separator">v</span> ${game.homeTeam}
                        </div>
                    </div>
                    <div class="rating ${ratingClass}">${ratingText}</div>
                    <div class="vote-container">
                        <button class="vote-btn upvote" data-game-id="${game.id}" data-vote="up">‚ñ≥</button>
                        <button class="vote-btn downvote" data-game-id="${game.id}" data-vote="down">‚ñΩ</button>
                        <div class="vote-tooltip">Agree with this rating?</div>
                    </div>
                    <div class="game-score ${shouldShowGameScore ? 'visible' : ''}">${gameScoreText}</div>
                    <button class="breakdown-toggle" data-game-id="${game.id}" data-breakdown='${JSON.stringify(game.breakdown || {})}'>View breakdown</button>
                    <div class="game-breakdown" id="breakdown-${game.id}"></div>
                    <a href="${recapUrl}" target="_blank" rel="noopener noreferrer" class="game-recap-link">See ESPN recap</a>
                </div>
            `;
        }

        // Attach score toggle listener
        function attachScoreToggleListener() {
            const toggle = document.getElementById('scoreToggle');
            if (toggle) {
                toggle.addEventListener('click', () => {
                    spoilerFree = !spoilerFree;
                    localStorage.setItem('spoilerFree', spoilerFree);
                    displayResults();
                });
            }
        }

        // Attach radar chart click listeners
        function attachRadarChartListeners() {
            document.querySelectorAll('.breakdown-toggle').forEach(button => {
                button.addEventListener('click', (e) => {
                    console.log('Breakdown button clicked');
                    console.log('Breakdown data:', button.dataset.breakdown);

                    try {
                        const breakdown = JSON.parse(button.dataset.breakdown);
                        console.log('Parsed breakdown:', breakdown);

                        const gameId = button.dataset.gameId;
                        const container = document.getElementById(`breakdown-${gameId}`);
                        console.log('Container found:', container);

                        if (container.innerHTML) {
                            console.log('Collapsing chart');
                            container.innerHTML = '';
                            button.textContent = 'View breakdown';
                        } else {
                            console.log('Rendering chart');
                            container.innerHTML = renderRadarChart(breakdown);
                            button.textContent = 'Hide breakdown';

                            // Attach hover listeners to metric labels
                            setTimeout(() => {
                                attachMetricHoverListeners(container);
                            }, 0);
                        }
                    } catch (error) {
                        console.error('Error in radar chart click handler:', error);
                    }
                });
            });
        }

        // Attach hover listeners to radar chart metric labels
        function attachMetricHoverListeners(container) {
            const labelGroups = container.querySelectorAll('.radar-label-group');
            const tooltip = container.querySelector('.metric-tooltip');

            if (!tooltip) return;

            labelGroups.forEach(group => {
                group.addEventListener('mouseenter', (e) => {
                    const desc = group.dataset.desc;
                    tooltip.textContent = desc;
                    tooltip.style.display = 'block';
                });

                group.addEventListener('mousemove', (e) => {
                    const rect = container.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                    tooltip.style.top = (e.clientY - rect.top + 10) + 'px';
                });

                group.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        }

        // Vote Management Functions
        function loadVotes() {
            try {
                const stored = localStorage.getItem('gameVotes');
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error('Error loading votes:', e);
                return {};
            }
        }

        function saveVotes(votes) {
            try {
                localStorage.setItem('gameVotes', JSON.stringify(votes));
            } catch (e) {
                console.error('Error saving votes:', e);
            }
        }

        function updateVoteUI(gameId, voteType) {
            const upButton = document.querySelector(`.vote-btn.upvote[data-game-id="${gameId}"]`);
            const downButton = document.querySelector(`.vote-btn.downvote[data-game-id="${gameId}"]`);

            if (upButton && downButton) {
                // Update active class
                upButton.classList.toggle('active', voteType === 'up');
                downButton.classList.toggle('active', voteType === 'down');

                // Update arrow character (hollow when inactive, filled when active)
                upButton.textContent = voteType === 'up' ? '‚ñ≤' : '‚ñ≥';
                downButton.textContent = voteType === 'down' ? '‚ñº' : '‚ñΩ';
            }
        }

        function handleVote(gameId, voteType) {
            const votes = loadVotes();
            const currentVote = votes[gameId];

            // Find the game object for Supabase payload
            const game = currentGames?.find(g => g.id === gameId);

            // Toggle off if clicking the same button
            if (currentVote === voteType) {
                delete votes[gameId];
                saveVotes(votes);
                updateVoteUI(gameId, null);
                // Delete from Supabase (fire and forget)
                if (typeof deleteVoteFromSupabase === 'function') {
                    deleteVoteFromSupabase(gameId);
                }
            } else {
                // Switch to new vote or set initial vote
                votes[gameId] = voteType;
                saveVotes(votes);
                updateVoteUI(gameId, voteType);
                // Upsert to Supabase (fire and forget)
                if (typeof upsertVoteToSupabase === 'function') {
                    upsertVoteToSupabase(gameId, voteType, game, selectedSport, selectedSeason, selectedWeek);
                }
            }
        }

        function attachVoteListeners() {
            const votes = loadVotes();

            document.querySelectorAll('.vote-btn').forEach(button => {
                const gameId = button.dataset.gameId;
                const voteType = button.dataset.vote;

                // Set initial active state and arrow character
                if (votes[gameId] === voteType) {
                    button.classList.add('active');
                    button.textContent = voteType === 'up' ? '‚ñ≤' : '‚ñº';
                }

                // Add click handler
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    handleVote(gameId, voteType);
                });
            });
        }

        // Team Lookup Functions
        async function loadTeams() {
            if (allTeams.length > 0) {
                displayTeams(allTeams);
                return;
            }

            try {
                const response = await fetch(`/api/teams?sport=${selectedSport}`);
                const data = await response.json();

                if (data.success && data.teams) {
                    allTeams = data.teams;
                    displayTeams(allTeams);
                }
            } catch (error) {
                console.error('Error loading teams:', error);
                document.getElementById('teamList').innerHTML = '<div style="color: #6b6560; padding: 8px;">Failed to load teams</div>';
            }
        }

        function displayTeams(teams) {
            const teamList = document.getElementById('teamList');
            teamList.innerHTML = '';

            if (teams.length === 0) {
                teamList.innerHTML = '<div style="color: #6b6560; padding: 8px;">No teams found</div>';
                return;
            }

            teams.forEach(team => {
                const teamItem = document.createElement('div');
                teamItem.className = 'team-item';
                teamItem.textContent = team.displayName;
                teamItem.addEventListener('click', () => {
                    selectTeam(team);
                });
                teamList.appendChild(teamItem);
            });
        }

        function filterTeams(query) {
            if (!query) {
                displayTeams(allTeams);
                return;
            }

            const filtered = allTeams.filter(team =>
                team.displayName.toLowerCase().includes(query.toLowerCase()) ||
                team.name.toLowerCase().includes(query.toLowerCase()) ||
                team.abbreviation.toLowerCase().includes(query.toLowerCase())
            );

            displayTeams(filtered);
        }

        function selectTeam(team) {
            selectedTeam = team;
            document.getElementById('teamPicker').classList.remove('visible');
            document.getElementById('teamSearchInput').value = '';
            loadSchedule(team);
        }

        async function loadSchedule(team) {
            viewMode = 'schedule';
            isLoading = true;
            showLoading(`loading ${team.displayName} schedule...`);

            try {
                const response = await fetch(`/api/schedule?sport=${selectedSport}&teamId=${team.id}&season=${selectedSeason}`);
                const data = await response.json();

                if (data.success && data.games) {
                    currentSchedule = data.games;
                    displaySchedule(data.team, data.games);
                } else {
                    showEmpty(`No completed games found for ${team.displayName} in ${selectedSeason}.`);
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                showEmpty('Failed to load schedule. Please try again.');
            } finally {
                isLoading = false;
            }
        }

        function displaySchedule(team, games) {
            const resultsArea = document.getElementById('resultsArea');

            let html = `
                <div class="schedule-view">
                    <div class="schedule-header">
                        <span class="team-name">${team.displayName}</span>
                        <span class="separator">¬∑</span>
                        <span class="schedule-season">${selectedSeason}</span>
                    </div>
                    <a href="#" class="back-link" id="backToWeek">‚Üê back to week ${selectedWeek}</a>

                    <div class="spoiler-toggle-wrapper">
                        <span class="toggle-label">show results</span>
                        <div class="toggle-switch ${!spoilerFree ? 'active' : ''}" id="scheduleScoreToggle">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>

                    <div class="schedule-list">
            `;

            games.forEach(game => {
                // Handle postseason/bowl game labeling
                const weekText = game.isPostseason
                    ? (game.bowlName || 'bowl game')
                    : (game.week ? `week ${game.week}` : game.displayDate);

                const locationPrefix = game.homeAway === 'home' ? 'vs' : '@';

                // Show results based on spoiler state
                const resultText = spoilerFree ? 'final' : game.result;

                html += `
                    <div class="schedule-row" data-game-id="${game.id}">
                        <span class="schedule-week">${weekText}</span>
                        <span class="separator">¬∑</span>
                        <span class="schedule-date">${game.displayDate}</span>
                        <span class="separator">¬∑</span>
                        <span class="schedule-opponent">${locationPrefix} ${game.opponent}</span>
                        <span class="separator">¬∑</span>
                        <span class="schedule-result">${resultText}</span>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            resultsArea.innerHTML = html;

            // Attach event listeners
            document.getElementById('backToWeek').addEventListener('click', (e) => {
                e.preventDefault();
                backToWeek();
            });

            // Toggle listener
            const toggle = document.getElementById('scheduleScoreToggle');
            if (toggle) {
                toggle.addEventListener('click', () => {
                    spoilerFree = !spoilerFree;
                    localStorage.setItem('spoilerFree', spoilerFree);
                    displaySchedule(team, games);  // Re-render with new spoiler state
                });
            }

            document.querySelectorAll('.schedule-row').forEach(row => {
                row.addEventListener('click', () => {
                    const gameId = row.dataset.gameId;
                    loadSingleGame(gameId);
                });
            });
        }

        async function loadSingleGame(gameId) {
            viewMode = 'single-game';
            selectedGameFromSchedule = gameId;
            isLoading = true;
            showLoading('analyzing game...');

            try {
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sport: selectedSport,
                        gameId: gameId
                    })
                });

                const data = await response.json();

                if (data.success && data.games && data.games.length > 0) {
                    displaySingleGame(data.games[0]);
                } else {
                    showEmpty('Could not analyze this game. Please try another.');
                }
            } catch (error) {
                console.error('Error loading single game:', error);
                showEmpty('Failed to load game. Please try again.');
            } finally {
                isLoading = false;
            }
        }

        function displaySingleGame(game) {
            const resultsArea = document.getElementById('resultsArea');

            let html = `
                <a href="#" class="back-link" id="backToSchedule">‚Üê back to ${selectedTeam.displayName.toLowerCase()} schedule</a>
                <div class="games-list">
                    ${createGameRow(game, 0)}
                </div>
            `;

            resultsArea.innerHTML = html;

            // Attach event listeners
            document.getElementById('backToSchedule').addEventListener('click', (e) => {
                e.preventDefault();
                backToSchedule();
            });

            attachRadarChartListeners();
        }

        function backToWeek() {
            viewMode = 'week';
            selectedTeam = null;
            currentSchedule = null;
            selectedGameFromSchedule = null;
            isInitialLoad = false; // User manually navigated back
            loadGames();
        }

        function backToSchedule() {
            viewMode = 'schedule';
            selectedGameFromSchedule = null;
            displaySchedule({ displayName: selectedTeam.displayName }, currentSchedule);
        }

        // ===== SEASON EXPORT FUNCTIONALITY =====

        let exportCancelled = false;

        // Get week range presets for a sport
        function getWeekRangePresets(sport) {
            if (sport === 'NFL') {
                return [
                    { label: 'All', value: 'all', start: 1, end: 18 },
                    { label: 'First Half', value: 'first-half', start: 1, end: 9 },
                    { label: 'Second Half', value: 'second-half', start: 10, end: 18 },
                    { label: 'Custom', value: 'custom', start: null, end: null }
                ];
            } else if (sport === 'CFB') {
                return [
                    { label: 'All', value: 'all', start: 1, end: 'bowls' },
                    { label: 'Regular Season', value: 'regular', start: 1, end: 15 },
                    { label: 'Bowls Only', value: 'bowls', start: 'bowls', end: 'bowls' },
                    { label: 'Custom', value: 'custom', start: null, end: null }
                ];
            } else if (sport === 'NBA') {
                // NBA uses date ranges
                const currentSeasonInfo = getCurrentWeek('NBA');
                const season = currentSeasonInfo.season;
                return [
                    { label: 'All', value: 'all', start: `${season}-10-01`, end: `${season + 1}-04-30` },
                    { label: 'Pre-All-Star', value: 'pre-allstar', start: `${season}-10-01`, end: `${season + 1}-02-15` },
                    { label: 'Post-All-Star', value: 'post-allstar', start: `${season + 1}-02-16`, end: `${season + 1}-04-30` },
                    { label: 'Custom', value: 'custom', start: null, end: null }
                ];
            }
            return [];
        }

        // Populate week range UI
        function populateWeekRangeUI(sport) {
            const weekRangeGroup = document.getElementById('weekRangeGroup');
            const dateRangeGroup = document.getElementById('dateRangeGroup');
            const exportPresets = document.getElementById('exportPresets');
            const exportDatePresets = document.getElementById('exportDatePresets');
            const exportStartWeek = document.getElementById('exportStartWeek');
            const exportEndWeek = document.getElementById('exportEndWeek');
            const validationMessage = document.getElementById('exportValidationMessage');

            // Clear validation message
            validationMessage.style.display = 'none';
            validationMessage.textContent = '';

            // Show/hide appropriate range UI
            if (sport === 'NBA') {
                weekRangeGroup.style.display = 'none';
                dateRangeGroup.style.display = 'block';
            } else {
                weekRangeGroup.style.display = 'block';
                dateRangeGroup.style.display = 'none';
            }

            // Get presets for the sport
            const presets = getWeekRangePresets(sport);

            // Populate preset buttons
            const presetsContainer = sport === 'NBA' ? exportDatePresets : exportPresets;
            presetsContainer.innerHTML = '';

            presets.forEach(preset => {
                const btn = document.createElement('button');
                btn.className = 'export-preset-btn';
                btn.textContent = preset.label;
                btn.dataset.value = preset.value;
                btn.dataset.start = preset.start;
                btn.dataset.end = preset.end;

                // Set "All" as default active
                if (preset.value === 'all') {
                    btn.classList.add('active');
                }

                presetsContainer.appendChild(btn);
            });

            // Populate week dropdowns for NFL/CFB
            if (sport !== 'NBA') {
                let weekOptions = [];
                if (sport === 'NFL') {
                    weekOptions = Array.from({ length: 18 }, (_, i) => ({ value: i + 1, label: `Week ${i + 1}` }));
                } else if (sport === 'CFB') {
                    weekOptions = Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `Week ${i + 1}` }));
                    weekOptions.push({ value: 'bowls', label: 'Bowls' });
                }

                exportStartWeek.innerHTML = weekOptions.map(opt =>
                    `<option value="${opt.value}">${opt.label}</option>`
                ).join('');
                exportEndWeek.innerHTML = weekOptions.map(opt =>
                    `<option value="${opt.value}">${opt.label}</option>`
                ).join('');

                // Set default to full range
                exportStartWeek.value = weekOptions[0].value;
                exportEndWeek.value = weekOptions[weekOptions.length - 1].value;
            }
        }

        // Handle preset selection
        function handlePresetSelection(sport, preset) {
            const exportCustomRange = document.getElementById('exportCustomRange');
            const exportCustomDateRange = document.getElementById('exportCustomDateRange');
            const exportStartWeek = document.getElementById('exportStartWeek');
            const exportEndWeek = document.getElementById('exportEndWeek');
            const exportStartDate = document.getElementById('exportStartDate');
            const exportEndDate = document.getElementById('exportEndDate');
            const validationMessage = document.getElementById('exportValidationMessage');

            // Clear validation
            validationMessage.style.display = 'none';
            validationMessage.textContent = '';

            if (preset.value === 'custom') {
                // Show custom range inputs
                if (sport === 'NBA') {
                    exportCustomDateRange.style.display = 'block';
                    const currentSeasonInfo = getCurrentWeek('NBA');
                    const season = currentSeasonInfo.season;
                    exportStartDate.value = `${season}-10-01`;
                    exportEndDate.value = `${season + 1}-04-30`;
                } else {
                    exportCustomRange.style.display = 'block';
                }
            } else {
                // Hide custom range inputs
                exportCustomRange.style.display = 'none';
                exportCustomDateRange.style.display = 'none';

                // Set values from preset
                if (sport === 'NBA') {
                    exportStartDate.value = preset.start;
                    exportEndDate.value = preset.end;
                } else {
                    exportStartWeek.value = preset.start;
                    exportEndWeek.value = preset.end;
                }
            }

            // Validate the selection
            validateRangeSelection(sport);
        }

        // Validate range selection
        function validateRangeSelection(sport) {
            const validationMessage = document.getElementById('exportValidationMessage');
            const downloadBtn = document.getElementById('exportDownloadBtn');

            if (sport === 'NBA') {
                const startDate = document.getElementById('exportStartDate').value;
                const endDate = document.getElementById('exportEndDate').value;

                if (!startDate || !endDate) {
                    validationMessage.textContent = 'Please select both start and end dates.';
                    validationMessage.style.display = 'block';
                    downloadBtn.disabled = true;
                    return false;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    validationMessage.textContent = 'End date must be after start date.';
                    validationMessage.style.display = 'block';
                    downloadBtn.disabled = true;
                    return false;
                }
            } else {
                const startWeek = document.getElementById('exportStartWeek').value;
                const endWeek = document.getElementById('exportEndWeek').value;

                // Handle bowls special case
                if (startWeek === 'bowls' && endWeek !== 'bowls') {
                    validationMessage.textContent = 'Invalid range: Bowls must be the end of the range.';
                    validationMessage.style.display = 'block';
                    downloadBtn.disabled = true;
                    return false;
                }

                // Compare numeric weeks
                if (startWeek !== 'bowls' && endWeek !== 'bowls' && parseInt(startWeek) > parseInt(endWeek)) {
                    validationMessage.textContent = 'Start week must be before or equal to end week.';
                    validationMessage.style.display = 'block';
                    downloadBtn.disabled = true;
                    return false;
                }
            }

            // Valid selection
            validationMessage.style.display = 'none';
            validationMessage.textContent = '';
            downloadBtn.disabled = false;
            return true;
        }

        // Open export modal
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            const overlay = document.getElementById('exportModalOverlay');
            const sportSelect = document.getElementById('exportSportSelect');
            const seasonSelect = document.getElementById('exportSeasonSelect');
            const warningDiv = document.getElementById('exportWarning');

            // Pre-fill with current selections
            sportSelect.value = selectedSport;

            // Populate season options (only current season available)
            const currentSeasonInfo = getCurrentWeek(selectedSport);
            seasonSelect.innerHTML = `<option value="${currentSeasonInfo.season}">${currentSeasonInfo.season}</option>`;

            // Show/hide NBA warning
            if (selectedSport === 'NBA') {
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }

            // Populate week range UI
            populateWeekRangeUI(selectedSport);

            // Show modal
            modal.classList.add('visible');
            overlay.classList.add('visible');

            // Reset export state
            exportCancelled = false;
            hideExportProgress();
        }

        // Close export modal
        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            const overlay = document.getElementById('exportModalOverlay');

            modal.classList.remove('visible');
            overlay.classList.remove('visible');

            // Cancel any in-progress export
            exportCancelled = true;
        }

        // Show export progress
        function showExportProgress(current, total, message) {
            const progressDiv = document.getElementById('exportProgress');
            const progressText = document.getElementById('exportProgressText');
            const progressFill = document.getElementById('exportProgressFill');
            const downloadBtn = document.getElementById('exportDownloadBtn');

            progressDiv.classList.add('visible');
            progressText.textContent = message;

            const percentage = (current / total) * 100;
            progressFill.style.width = `${percentage}%`;

            // Disable download button during export
            downloadBtn.disabled = true;
        }

        // Hide export progress
        function hideExportProgress() {
            const progressDiv = document.getElementById('exportProgress');
            const downloadBtn = document.getElementById('exportDownloadBtn');

            progressDiv.classList.remove('visible');
            downloadBtn.disabled = false;
        }

        // Get range information for display and filename
        function getRangeInfo(sport, rangeStart, rangeEnd) {
            let isPartial = false;
            let label = '';
            let filenameSuffix = 'full-season';

            if (sport === 'NFL') {
                const defaultStart = 1;
                const defaultEnd = 18;
                isPartial = rangeStart !== defaultStart || rangeEnd !== defaultEnd;
                if (isPartial) {
                    label = `weeks ${rangeStart}-${rangeEnd}`;
                    filenameSuffix = `weeks-${rangeStart}-${rangeEnd}`;
                }
            } else if (sport === 'CFB') {
                const isBowlsOnly = rangeStart === 'bowls' && rangeEnd === 'bowls';
                const isFullSeason = rangeStart === 1 && rangeEnd === 'bowls';

                if (isBowlsOnly) {
                    isPartial = true;
                    label = 'bowls only';
                    filenameSuffix = 'bowls';
                } else if (!isFullSeason) {
                    isPartial = true;
                    if (rangeEnd === 'bowls') {
                        label = `weeks ${rangeStart}-15 + bowls`;
                        filenameSuffix = `weeks-${rangeStart}-bowls`;
                    } else {
                        label = `weeks ${rangeStart}-${rangeEnd}`;
                        filenameSuffix = `weeks-${rangeStart}-${rangeEnd}`;
                    }
                }
            } else if (sport === 'NBA') {
                // Check if it's a partial season by comparing dates
                const currentSeasonInfo = getCurrentWeek('NBA');
                const season = currentSeasonInfo.season;
                const defaultStart = `${season}-10-01`;
                const defaultEnd = `${season + 1}-04-30`;

                if (rangeStart && rangeEnd && (rangeStart !== defaultStart || rangeEnd !== defaultEnd)) {
                    isPartial = true;
                    // Format dates for display (e.g., "Oct-Dec")
                    const startDate = new Date(rangeStart);
                    const endDate = new Date(rangeEnd);
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const startMonth = monthNames[startDate.getMonth()];
                    const endMonth = monthNames[endDate.getMonth()];
                    label = `${startMonth}-${endMonth}`;
                    filenameSuffix = `${startMonth.toLowerCase()}-${endMonth.toLowerCase()}`;
                }
            }

            return { isPartial, label, filenameSuffix };
        }

        // Fetch all weeks for a season
        async function fetchAllWeeks(sport, season, rangeStart = null, rangeEnd = null) {
            const allGames = [];
            let weeks = [];
            let useDateBasedFetch = false;

            // Determine weeks to fetch based on sport
            if (sport === 'NFL') {
                const start = rangeStart || 1;
                const end = rangeEnd || 18;
                weeks = Array.from({ length: end - start + 1 }, (_, i) => start + i);
            } else if (sport === 'CFB') {
                const start = (rangeStart === 'bowls') ? 'bowls' : (rangeStart || 1);
                const end = (rangeEnd === 'bowls') ? 'bowls' : (rangeEnd || 15);

                if (start === 'bowls' && end === 'bowls') {
                    // Bowls only
                    weeks = ['bowls'];
                } else if (start === 'bowls') {
                    // Invalid: can't start with bowls
                    weeks = ['bowls'];
                } else {
                    // Regular weeks
                    weeks = Array.from({ length: end - start + 1 }, (_, i) => start + i);
                    // Add bowls if end is 'bowls'
                    if (rangeEnd === 'bowls') {
                        weeks.push('bowls');
                    }
                }
            } else if (sport === 'NBA') {
                // NBA uses date-based fetching
                useDateBasedFetch = true;
                // Use provided date range or default to Oct 1 - Today
                const startDate = rangeStart ? new Date(rangeStart) : new Date(season, 9, 1);
                const endDate = rangeEnd ? new Date(rangeEnd) : new Date();
                const daysDiff = Math.floor((endDate - startDate) / (24 * 60 * 60 * 1000));

                weeks = Array.from({ length: daysDiff + 1 }, (_, i) => {
                    const date = new Date(startDate);
                    date.setDate(date.getDate() + i);
                    return date.toISOString().split('T')[0];
                });
            }

            const totalWeeks = weeks.length;
            const rangeInfo = getRangeInfo(sport, rangeStart, rangeEnd);

            for (let i = 0; i < weeks.length; i++) {
                if (exportCancelled) {
                    throw new Error('Export cancelled by user');
                }

                const week = weeks[i];
                let progressMessage;

                if (useDateBasedFetch) {
                    if (rangeInfo.isPartial) {
                        progressMessage = `Fetching date ${i + 1} of ${totalWeeks} (${rangeInfo.label})...`;
                    } else {
                        progressMessage = `Fetching date ${i + 1} of ${totalWeeks}...`;
                    }
                } else if (week === 'bowls') {
                    progressMessage = `Fetching bowl games...`;
                } else {
                    if (rangeInfo.isPartial) {
                        progressMessage = `Fetching week ${week} (${rangeInfo.label})...`;
                    } else {
                        progressMessage = `Fetching week ${week} of ${totalWeeks}...`;
                    }
                }

                showExportProgress(i + 1, totalWeeks, progressMessage);

                try {
                    // Try static file first
                    const staticData = await fetchStaticData(sport, season, week);
                    if (staticData && staticData.success && staticData.games) {
                        console.log(`‚úÖ ${useDateBasedFetch ? 'Date' : 'Week'} ${week}: loaded from static`);
                        staticData.games.forEach(game => {
                            game.week = week;
                            allGames.push(game);
                        });
                    } else {
                        // Fall back to API
                        console.log(`‚ö†Ô∏è ${useDateBasedFetch ? 'Date' : 'Week'} ${week}: falling back to API`);

                        let requestBody;
                        if (useDateBasedFetch) {
                            requestBody = {
                                sport: sport,
                                date: week
                            };
                        } else {
                            requestBody = {
                                sport: sport,
                                season: season,
                                week: week,
                                seasonType: '2'
                            };
                        }

                        const response = await fetch('/api/games', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        const data = await response.json();

                        if (data.success && data.games && data.games.length > 0) {
                            // Add week/date info to each game for Excel
                            data.games.forEach(game => {
                                game.week = week;
                                allGames.push(game);
                            });
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching ${useDateBasedFetch ? 'date' : 'week'} ${week}:`, error);
                    // Continue with remaining weeks even if one fails
                }

                // Add small delay to avoid hammering the API
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            return allGames;
        }

        // Export full season to Excel
        async function exportFullSeason() {
            const sportSelect = document.getElementById('exportSportSelect');
            const seasonSelect = document.getElementById('exportSeasonSelect');

            const sport = sportSelect.value;
            const season = parseInt(seasonSelect.value);

            // Get selected range
            let rangeStart, rangeEnd;
            if (sport === 'NBA') {
                rangeStart = document.getElementById('exportStartDate').value;
                rangeEnd = document.getElementById('exportEndDate').value;
            } else {
                rangeStart = document.getElementById('exportStartWeek').value;
                rangeEnd = document.getElementById('exportEndWeek').value;
                // Convert to numbers if not 'bowls'
                if (rangeStart !== 'bowls') rangeStart = parseInt(rangeStart);
                if (rangeEnd !== 'bowls') rangeEnd = parseInt(rangeEnd);
            }

            // Validate range before proceeding
            if (!validateRangeSelection(sport)) {
                return;
            }

            try {
                showExportProgress(0, 100, 'Starting export...');

                // Fetch all games for the selected range
                const allGames = await fetchAllWeeks(sport, season, rangeStart, rangeEnd);

                if (allGames.length === 0) {
                    const validationMessage = document.getElementById('exportValidationMessage');
                    validationMessage.textContent = 'No completed games in selected range.';
                    validationMessage.style.display = 'block';
                    hideExportProgress();
                    return;
                }

                // Sort by excitement score descending
                allGames.sort((a, b) => (b.excitement || 0) - (a.excitement || 0));

                showExportProgress(1, 1, 'Generating Excel file...');

                // Generate Excel file
                const workbook = XLSX.utils.book_new();

                // Prepare data for Excel
                const excelData = allGames.map((game, index) => {
                    const rating = game.excitement || 0;
                    let tier;
                    if (rating >= 8) tier = 'Must Watch';
                    else if (rating >= 6) tier = 'Recommended';
                    else tier = 'Skip';

                    // Format week - handle bowls and dates
                    let weekDisplay;
                    if (sport === 'NBA') {
                        weekDisplay = game.week; // Date string
                    } else if (game.week === 'bowls' || game.bowlName) {
                        weekDisplay = 'Bowl';
                    } else {
                        weekDisplay = game.week;
                    }

                    // Format date
                    let dateDisplay = '';
                    if (game.date) {
                        const gameDate = new Date(game.date);
                        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                          'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        dateDisplay = `${monthNames[gameDate.getMonth()]} ${gameDate.getDate()}`;
                    }

                    return {
                        'Rank': index + 1,
                        'Rating': rating.toFixed(1),
                        'Tier': tier,
                        'Week': weekDisplay,
                        'Date': dateDisplay,
                        'Away Team': game.awayTeam,
                        'Home Team': game.homeTeam,
                        'Away Score': game.awayScore || 0,
                        'Home Score': game.homeScore || 0,
                        'OT': game.overtime ? 'Yes' : 'No',
                        'Bowl': game.bowlName || ''
                    };
                });

                // Create worksheet from data
                const worksheet = XLSX.utils.json_to_sheet(excelData);

                // Set column widths
                worksheet['!cols'] = [
                    { wch: 6 },  // Rank
                    { wch: 8 },  // Rating
                    { wch: 14 }, // Tier
                    { wch: 10 }, // Week
                    { wch: 10 }, // Date
                    { wch: 20 }, // Away Team
                    { wch: 20 }, // Home Team
                    { wch: 12 }, // Away Score
                    { wch: 12 }, // Home Score
                    { wch: 6 },  // OT
                    { wch: 25 }  // Bowl
                ];

                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Games');

                // Generate filename with range info
                const rangeInfo = getRangeInfo(sport, rangeStart, rangeEnd);
                let filename;
                if (sport === 'NBA') {
                    filename = `gei-nba-${season}-${season + 1}-${rangeInfo.filenameSuffix}.xlsx`;
                } else {
                    filename = `gei-${sport.toLowerCase()}-${season}-${rangeInfo.filenameSuffix}.xlsx`;
                }

                // Download file
                XLSX.writeFile(workbook, filename);

                // Close modal
                hideExportProgress();
                closeExportModal();

            } catch (error) {
                console.error('Export error:', error);
                hideExportProgress();

                if (error.message === 'Export cancelled by user') {
                    alert('Export cancelled.');
                } else {
                    alert('Export failed. Please try again.');
                }
            }
        }

        // Attach export modal event listeners
        function attachExportListeners() {
            // Export season link
            document.getElementById('exportSeasonLink').addEventListener('click', (e) => {
                e.preventDefault();
                openExportModal();
            });

            // Cancel button
            document.getElementById('exportCancelBtn').addEventListener('click', () => {
                closeExportModal();
            });

            // Download button
            document.getElementById('exportDownloadBtn').addEventListener('click', () => {
                exportFullSeason();
            });

            // Close modal when clicking overlay
            document.getElementById('exportModalOverlay').addEventListener('click', () => {
                closeExportModal();
            });

            // Update warning and season when sport changes
            document.getElementById('exportSportSelect').addEventListener('change', (e) => {
                const sport = e.target.value;
                const warningDiv = document.getElementById('exportWarning');
                const seasonSelect = document.getElementById('exportSeasonSelect');

                // Show/hide NBA warning
                if (sport === 'NBA') {
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.style.display = 'none';
                }

                // Update season options
                const currentSeasonInfo = getCurrentWeek(sport);
                seasonSelect.innerHTML = `<option value="${currentSeasonInfo.season}">${currentSeasonInfo.season}</option>`;

                // Repopulate week range UI
                populateWeekRangeUI(sport);
            });

            // Event delegation for preset buttons (since they're dynamically created)
            document.getElementById('exportPresets').addEventListener('click', (e) => {
                if (e.target.classList.contains('export-preset-btn')) {
                    const sport = document.getElementById('exportSportSelect').value;

                    // Remove active class from all buttons
                    document.querySelectorAll('#exportPresets .export-preset-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // Add active class to clicked button
                    e.target.classList.add('active');

                    // Handle preset selection
                    const preset = {
                        value: e.target.dataset.value,
                        start: e.target.dataset.start === 'null' ? null : e.target.dataset.start,
                        end: e.target.dataset.end === 'null' ? null : e.target.dataset.end
                    };

                    // Convert to numbers if applicable
                    if (preset.start && preset.start !== 'bowls') {
                        preset.start = parseInt(preset.start);
                    }
                    if (preset.end && preset.end !== 'bowls') {
                        preset.end = parseInt(preset.end);
                    }

                    handlePresetSelection(sport, preset);
                }
            });

            // Event delegation for NBA date preset buttons
            document.getElementById('exportDatePresets').addEventListener('click', (e) => {
                if (e.target.classList.contains('export-preset-btn')) {
                    const sport = document.getElementById('exportSportSelect').value;

                    // Remove active class from all buttons
                    document.querySelectorAll('#exportDatePresets .export-preset-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // Add active class to clicked button
                    e.target.classList.add('active');

                    // Handle preset selection
                    const preset = {
                        value: e.target.dataset.value,
                        start: e.target.dataset.start === 'null' ? null : e.target.dataset.start,
                        end: e.target.dataset.end === 'null' ? null : e.target.dataset.end
                    };

                    handlePresetSelection(sport, preset);
                }
            });

            // Custom range inputs validation
            document.getElementById('exportStartWeek').addEventListener('change', () => {
                const sport = document.getElementById('exportSportSelect').value;
                validateRangeSelection(sport);
            });

            document.getElementById('exportEndWeek').addEventListener('change', () => {
                const sport = document.getElementById('exportSportSelect').value;
                validateRangeSelection(sport);
            });

            document.getElementById('exportStartDate').addEventListener('change', () => {
                validateRangeSelection('NBA');
            });

            document.getElementById('exportEndDate').addEventListener('change', () => {
                validateRangeSelection('NBA');
            });
        }

        // Start the app
        init();
        attachExportListeners();
    </script>
</body>
</html>
