<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Index</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom, #FAFAF9 0%, #F5F5F4 100%);
            min-height: 100vh;
            color: #1A1A1A;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 60px;
        }

        h1 {
            font-size: 40px;
            font-weight: 700;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 14px;
            color: #666;
            font-weight: 400;
        }

        .accent-line {
            height: 2px;
            background: linear-gradient(to right, transparent, #2563EB, transparent);
            margin-top: 24px;
        }

        /* Selection Card */
        .selection-card {
            background: #FFFFFF;
            max-width: 600px;
            margin: 0 auto;
            padding: 48px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 32px;
        }

        .form-group:last-of-type {
            margin-bottom: 40px;
        }

        label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 12px;
        }

        /* Sport Selector (Radio Pills) */
        .radio-group {
            display: flex;
            gap: 12px;
        }

        .radio-pill {
            flex: 1;
        }

        .radio-pill input[type="radio"] {
            display: none;
        }

        .radio-pill label {
            display: block;
            text-align: center;
            padding: 12px 24px;
            border: 1px solid #E5E7EB;
            background: #FFFFFF;
            color: #1A1A1A;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            text-transform: none;
            letter-spacing: 0;
            margin: 0;
        }

        .radio-pill input[type="radio"]:checked + label {
            background: #2563EB;
            color: #FFFFFF;
            border-color: #2563EB;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        .radio-pill label:hover {
            border-color: #2563EB;
        }

        /* Season Dropdown */
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #E5E7EB;
            background: #FFFFFF;
            font-size: 14px;
            font-family: inherit;
            color: #1A1A1A;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%231A1A1A' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 48px;
        }

        select:focus {
            outline: none;
            border-color: #2563EB;
        }

        /* Week Grid */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .week-button {
            padding: 12px;
            border: 1px solid #E5E7EB;
            background: #FAFAF9;
            color: #1A1A1A;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-button:hover {
            border-color: #2563EB;
            background: #FFFFFF;
        }

        .week-button.selected {
            background: #2563EB;
            color: #FFFFFF;
            border-color: #2563EB;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
        }

        /* Analyze Button */
        .analyze-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(to bottom, #2563EB, #1D4ED8);
            color: #FFFFFF;
            border: none;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
            transition: all 0.2s;
            font-family: inherit;
        }

        .analyze-button:hover:not(:disabled) {
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        .analyze-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .analyze-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Results Section */
        .results-section {
            max-width: 1100px;
            margin: 60px auto 0;
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            flex: 1;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .results-title {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .results-subtitle {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-top: 8px;
        }

        .change-week {
            font-size: 14px;
            color: #2563EB;
            text-decoration: none;
            cursor: pointer;
        }

        .change-week:hover {
            text-decoration: underline;
        }

        /* Spoiler Toggle */
        .spoiler-toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .spoiler-toggle-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E5E7EB;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #2563EB;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Game Cards */
        .game-card {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            margin-bottom: 12px;
            padding: 20px 32px;
            display: grid;
            grid-template-columns: 80px 120px 1fr auto;
            gap: 32px;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .game-card:hover {
            border-color: #2563EB;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .game-score {
            font-size: 56px;
            font-weight: 600;
            color: #2563EB;
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }

        .score-bar-container {
            width: 120px;
        }

        .score-bar-bg {
            width: 100%;
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #2563EB, #3B82F6);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .game-info {
            min-width: 0;
        }

        .team-matchup {
            font-size: 17px;
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }

        .vs {
            font-weight: 400;
            color: #666;
        }

        .final-score {
            font-size: 14px;
            color: #666;
        }

        .final-score.spoiler-hidden {
            font-style: italic;
            color: #2563EB;
            cursor: pointer;
            user-select: none;
        }

        .final-score.spoiler-hidden:hover {
            color: #1D4ED8;
            text-decoration: underline;
        }

        .watch-link {
            font-size: 14px;
            color: #2563EB;
            text-decoration: none;
            white-space: nowrap;
        }

        .watch-link:hover {
            text-decoration: underline;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            color: #1A1A1A;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 14px;
            color: #666;
        }

        .loading-dots {
            display: inline-flex;
            gap: 8px;
            margin-top: 24px;
        }

        .loading-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2563EB;
            animation: pulse 1.4s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 80px;
            font-weight: 200;
            color: #D1D5DB;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .empty-message {
            font-size: 16px;
            color: #666;
        }

        @media (max-width: 768px) {
            .game-card {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px;
            }

            .game-score {
                font-size: 48px;
            }

            .score-bar-container {
                width: 100%;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .results-title {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>GAME INDEX</h1>
            <p class="tagline">Find the most entertaining games to watch</p>
            <div class="accent-line"></div>
        </header>

        <div class="selection-card" id="selectionCard">
            <div class="form-group">
                <label>Sport</label>
                <div class="radio-group">
                    <div class="radio-pill">
                        <input type="radio" id="nfl" name="sport" value="NFL" checked>
                        <label for="nfl">NFL</label>
                    </div>
                    <div class="radio-pill">
                        <input type="radio" id="cfb" name="sport" value="CFB">
                        <label for="cfb">CFB</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="season">Season</label>
                <select id="season">
                    <!-- Populated by JavaScript -->
                </select>
            </div>

            <div class="form-group">
                <label>Week</label>
                <div class="week-grid" id="weekGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <button class="analyze-button" id="analyzeButton">
                Analyze Games
            </button>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="header-left">
                    <h2 class="results-title" id="resultsTitle"></h2>
                    <p class="results-subtitle" id="resultsSubtitle"></p>
                </div>
                <div class="header-controls">
                    <div class="spoiler-toggle-container">
                        <span class="spoiler-toggle-label">Hide Scores</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="spoilerToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <a class="change-week" id="changeWeek">← Change Week</a>
                </div>
            </div>
            <div id="gamesContainer">
                <!-- Games populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Get current NFL week based on date
        function getCurrentNFLWeek() {
            const now = new Date();
            const year = now.getFullYear();

            // NFL season typically starts first Thursday in September
            // Week 1 is around Sept 5-12
            const seasonStart = new Date(year, 8, 5); // Sept 5

            // Adjust to first Thursday
            const dayOfWeek = seasonStart.getDay();
            const daysUntilThursday = (4 - dayOfWeek + 7) % 7;
            seasonStart.setDate(seasonStart.getDate() + daysUntilThursday);

            // If we're before the season start, use last year
            if (now < seasonStart) {
                const lastYearStart = new Date(year - 1, 8, 5);
                const lastYearDay = lastYearStart.getDay();
                const lastYearDaysUntilThursday = (4 - lastYearDay + 7) % 7;
                lastYearStart.setDate(lastYearStart.getDate() + lastYearDaysUntilThursday);

                const weeksSinceStart = Math.floor((now - lastYearStart) / (7 * 24 * 60 * 60 * 1000));
                const week = Math.min(18, Math.max(1, weeksSinceStart + 1));

                return { season: year - 1, week: week };
            }

            // Calculate weeks since season start
            const weeksSinceStart = Math.floor((now - seasonStart) / (7 * 24 * 60 * 60 * 1000));
            let week = weeksSinceStart + 1;

            // If current week hasn't had games yet (it's before Thursday), use previous week
            const currentDayOfWeek = now.getDay();
            if (currentDayOfWeek < 4) { // Before Thursday
                week = Math.max(1, week - 1);
            }

            // Cap at week 18
            week = Math.min(18, Math.max(1, week));

            return { season: year, week: week };
        }

        // Initialize with current NFL week
        const currentNFLWeek = getCurrentNFLWeek();

        // State
        let selectedSport = 'NFL';
        let selectedSeason = currentNFLWeek.season;
        let selectedWeek = currentNFLWeek.week;
        let spoilerFree = localStorage.getItem('spoilerFree') !== 'false'; // Default true
        let revealedGames = new Set();

        // Initialize
        function init() {
            populateSeasons();
            populateWeeks();
            attachEventListeners();
            initializeSpoilerToggle();

            // Auto-load the current week's games
            setTimeout(() => {
                analyzeGames();
            }, 500);
        }

        // Initialize spoiler toggle from localStorage
        function initializeSpoilerToggle() {
            const toggle = document.getElementById('spoilerToggle');
            if (toggle) {
                toggle.checked = spoilerFree;
            }
        }

        // Populate season dropdown
        function populateSeasons() {
            const seasonSelect = document.getElementById('season');
            const currentYear = new Date().getFullYear();
            const startYear = 2016;

            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === selectedSeason) option.selected = true;
                seasonSelect.appendChild(option);
            }
        }

        // Populate week grid
        function populateWeeks() {
            const weekGrid = document.getElementById('weekGrid');
            weekGrid.innerHTML = '';

            const maxWeeks = selectedSport === 'NFL' ? 18 : 15;

            for (let i = 1; i <= maxWeeks; i++) {
                const button = document.createElement('button');
                button.className = 'week-button';
                button.textContent = i;
                button.dataset.week = i;

                if (i === selectedWeek) {
                    button.classList.add('selected');
                }

                button.addEventListener('click', () => selectWeek(i));
                weekGrid.appendChild(button);
            }
        }

        // Select week
        function selectWeek(week) {
            selectedWeek = week;
            document.querySelectorAll('.week-button').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.week) === week);
            });
        }

        // Attach event listeners
        function attachEventListeners() {
            // Sport radio buttons
            document.querySelectorAll('input[name="sport"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedSport = e.target.value;
                    selectedWeek = 1;
                    populateWeeks();
                });
            });

            // Season dropdown
            document.getElementById('season').addEventListener('change', (e) => {
                selectedSeason = parseInt(e.target.value);
            });

            // Analyze button
            document.getElementById('analyzeButton').addEventListener('click', analyzeGames);

            // Change week link
            document.getElementById('changeWeek').addEventListener('click', () => {
                document.getElementById('resultsSection').classList.remove('visible');
                document.getElementById('selectionCard').scrollIntoView({ behavior: 'smooth' });
            });

            // Spoiler toggle
            document.getElementById('spoilerToggle').addEventListener('change', (e) => {
                spoilerFree = e.target.checked;
                localStorage.setItem('spoilerFree', spoilerFree);
                revealedGames.clear(); // Reset revealed games when toggling

                // Re-render games if results are visible
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection.classList.contains('visible') && window.currentGames) {
                    displayResults(window.currentGames);
                }
            });
        }

        // Analyze games
        async function analyzeGames() {
            const button = document.getElementById('analyzeButton');
            button.disabled = true;
            button.textContent = 'Analyzing...';

            // Show loading state
            showLoading();

            try {
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sport: selectedSport,
                        season: selectedSeason,
                        week: selectedWeek,
                        seasonType: '2' // Regular season
                    })
                });

                const data = await response.json();

                if (data.success && data.games && data.games.length > 0) {
                    displayResults(data.games);
                } else {
                    showEmpty();
                }
            } catch (error) {
                console.error('Error:', error);
                showEmpty('Could not load games. Please try again.');
            } finally {
                button.disabled = false;
                button.textContent = 'Analyze Games';
            }
        }

        // Show loading state
        function showLoading() {
            const resultsSection = document.getElementById('resultsSection');
            const gamesContainer = document.getElementById('gamesContainer');

            gamesContainer.innerHTML = `
                <div class="loading">
                    <div class="loading-text">Analyzing games...</div>
                    <div class="loading-subtext">Fetching data from ESPN</div>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;

            resultsSection.classList.add('visible');
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Show empty state
        function showEmpty(message = 'No games found for this week') {
            const gamesContainer = document.getElementById('gamesContainer');
            gamesContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">0</div>
                    <div class="empty-title">No games found</div>
                    <div class="empty-message">${message}</div>
                </div>
            `;
        }

        // Display results
        function displayResults(games) {
            // Store current games for re-rendering
            window.currentGames = games;

            // Sort by excitement score
            games.sort((a, b) => (b.excitement || 0) - (a.excitement || 0));

            // Update header
            document.getElementById('resultsTitle').textContent =
                `Week ${selectedWeek}, ${selectedSeason} ${selectedSport}`;
            document.getElementById('resultsSubtitle').textContent =
                `${games.length} games analyzed • Ranked by entertainment`;

            // Generate game cards
            const gamesContainer = document.getElementById('gamesContainer');
            gamesContainer.innerHTML = games.map((game, index) => createGameCard(game, index)).join('');

            // Attach click listeners for spoiler reveals
            attachGameClickListeners();
        }

        // Attach click listeners to game cards for spoiler reveal
        function attachGameClickListeners() {
            if (!spoilerFree) return;

            document.querySelectorAll('.final-score.spoiler-hidden').forEach(scoreEl => {
                scoreEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const gameIndex = parseInt(scoreEl.dataset.gameIndex);
                    revealedGames.add(gameIndex);

                    // Re-render to show the revealed score
                    if (window.currentGames) {
                        displayResults(window.currentGames);
                    }
                });
            });
        }

        // Create game card HTML
        function createGameCard(game, index) {
            const score = game.excitement || 0;
            const percentage = Math.min(100, (score / 10) * 100);

            // Team colors (simplified - you can expand this)
            const teamColors = {
                'Chiefs': '#E31837',
                'Bills': '#00338D',
                'Eagles': '#004C54',
                'Cowboys': '#041E42',
                // Add more as needed
            };

            const awayColor = teamColors[game.awayTeam] || '#666';
            const homeColor = teamColors[game.homeTeam] || '#666';

            const highlightUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(
                `${game.awayTeam} vs ${game.homeTeam} ${selectedSport} highlights ${selectedSeason}`
            )}`;

            // Determine if this game's score should be hidden
            const isGameRevealed = revealedGames.has(index);
            const shouldHideScore = spoilerFree && !isGameRevealed;

            let scoreDisplay;
            if (shouldHideScore) {
                scoreDisplay = `<div class="final-score spoiler-hidden" data-game-index="${index}">Click to reveal score</div>`;
            } else {
                scoreDisplay = `<div class="final-score">Final: ${game.awayScore || 0} - ${game.homeScore || 0}${game.overtime ? ' (OT)' : ''}</div>`;
            }

            return `
                <div class="game-card">
                    <div class="game-score">${score.toFixed(1)}</div>
                    <div class="score-bar-container">
                        <div class="score-bar-bg">
                            <div class="score-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="game-info">
                        <div class="team-matchup">
                            <span class="team-dot" style="background: ${awayColor}"></span>
                            ${game.awayTeam}
                            <span class="vs">vs</span>
                            <span class="team-dot" style="background: ${homeColor}"></span>
                            ${game.homeTeam}
                        </div>
                        ${scoreDisplay}
                    </div>
                    <a href="${highlightUrl}" target="_blank" class="watch-link">
                        Watch →
                    </a>
                </div>
            `;
        }

        // Start the app
        init();
    </script>
</body>
</html>
