name: Generate Static Game Data

on:
  schedule:
    # NFL: Tuesday 10 AM UTC (5 AM EST, after Monday Night Football)
    - cron: '0 10 * 9-12,1-2 2'
    # CFB: Sunday 8 AM UTC (3 AM EST, after Saturday games) during regular season
    - cron: '0 8 * 8-11 0'
    # CFB: Daily 10 AM UTC (5 AM EST) during bowl/playoff season (Dec-Jan)
    - cron: '0 10 * 12,1 *'
    # NBA: Daily 10 AM UTC (5 AM EST, after West Coast games)
    - cron: '0 10 * 10-12,1-6 *'
  workflow_dispatch:
    inputs:
      sport:
        description: 'Sport to generate (NFL, CFB, NBA, or all)'
        required: false
        default: 'all'
      force:
        description: 'Force regenerate existing files'
        required: false
        default: 'false'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Determine what to generate
        id: determine
        run: |
          DAY_OF_WEEK=$(date +%u)
          MONTH=$(date +%-m)

          # Manual trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "sport=${{ github.event.inputs.sport }}" >> $GITHUB_OUTPUT
            echo "force=${{ github.event.inputs.force }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build a list of sports to generate (can be multiple)
          SPORTS=""

          # NFL: Tuesday during season (Sept-Feb), or Sunday/Monday during playoffs (Jan-Feb)
          if [ "$DAY_OF_WEEK" = "2" ] && ([ "$MONTH" -ge 9 ] || [ "$MONTH" -le 2 ]); then
            SPORTS="NFL"
          elif ([ "$DAY_OF_WEEK" = "7" ] || [ "$DAY_OF_WEEK" = "1" ]) && ([ "$MONTH" = "1" ] || [ "$MONTH" = "2" ]); then
            SPORTS="NFL"
          fi

          # CFB: Sunday during regular season (Aug-Nov), or daily during bowl/playoff season (Dec-Jan)
          if [ "$DAY_OF_WEEK" = "7" ] && [ "$MONTH" -ge 8 ] && [ "$MONTH" -le 11 ]; then
            SPORTS="${SPORTS:+$SPORTS,}CFB"
          elif [ "$MONTH" = "12" ] || [ "$MONTH" = "1" ]; then
            SPORTS="${SPORTS:+$SPORTS,}CFB"
          fi

          # NBA: Daily during season (October through June)
          if [ "$MONTH" -ge 10 ] || [ "$MONTH" -le 6 ]; then
            SPORTS="${SPORTS:+$SPORTS,}NBA"
          fi

          # Default to none if no sports matched
          if [ -z "$SPORTS" ]; then
            SPORTS="none"
          fi

          echo "sport=$SPORTS" >> $GITHUB_OUTPUT
          echo "force=false" >> $GITHUB_OUTPUT

      - name: Generate NFL data
        if: contains(steps.determine.outputs.sport, 'NFL') || steps.determine.outputs.sport == 'all'
        run: |
          CURRENT_WEEK=$(node -e "
            const now = new Date();
            const seasonStart = new Date(2025, 8, 4); // Sept 4, 2025
            const weeks = Math.floor((now - seasonStart) / (7 * 24 * 60 * 60 * 1000));
            console.log(Math.min(18, Math.max(1, weeks)));
          ")
          echo "Generating NFL week $CURRENT_WEEK"
          node scripts/generate-static.js --sport NFL --season 2025 --week $CURRENT_WEEK ${{ steps.determine.outputs.force == 'true' && '--force' || '' }} || echo "NFL generation completed with warnings"

          # Generate NFL playoff rounds if in January/February
          MONTH=$(date +%-m)
          DAY=$(date +%-d)
          if [ "$MONTH" = "1" ] && [ "$DAY" -ge 10 ]; then
            echo "Generating NFL playoff rounds"
            # Wild Card (mid-January)
            node scripts/generate-static.js --sport NFL --season 2024 --week wild-card --force || echo "NFL wild-card generation completed with warnings"
            # Divisional (late January)
            if [ "$DAY" -ge 17 ]; then
              node scripts/generate-static.js --sport NFL --season 2024 --week divisional --force || echo "NFL divisional generation completed with warnings"
            fi
            # Conference Championships (late January)
            if [ "$DAY" -ge 24 ]; then
              node scripts/generate-static.js --sport NFL --season 2024 --week conference --force || echo "NFL conference generation completed with warnings"
            fi
          fi
          if [ "$MONTH" = "2" ]; then
            echo "Generating NFL playoff rounds (February)"
            # Generate all playoff rounds in February
            node scripts/generate-static.js --sport NFL --season 2024 --week wild-card --force || echo "NFL wild-card generation completed with warnings"
            node scripts/generate-static.js --sport NFL --season 2024 --week divisional --force || echo "NFL divisional generation completed with warnings"
            node scripts/generate-static.js --sport NFL --season 2024 --week conference --force || echo "NFL conference generation completed with warnings"
            # Super Bowl (early February)
            if [ "$DAY" -ge 9 ]; then
              node scripts/generate-static.js --sport NFL --season 2024 --week super-bowl --force || echo "NFL super-bowl generation completed with warnings"
            fi
          fi

      - name: Generate CFB data
        if: contains(steps.determine.outputs.sport, 'CFB') || steps.determine.outputs.sport == 'all'
        run: |
          CURRENT_WEEK=$(node -e "
            const now = new Date();
            const seasonStart = new Date(2025, 7, 23); // Aug 23, 2025
            const weeks = Math.floor((now - seasonStart) / (7 * 24 * 60 * 60 * 1000));
            console.log(Math.min(15, Math.max(1, weeks)));
          ")
          echo "Generating CFB week $CURRENT_WEEK"
          node scripts/generate-static.js --sport CFB --season 2025 --week $CURRENT_WEEK ${{ steps.determine.outputs.force == 'true' && '--force' || '' }} || echo "CFB generation completed with warnings"

          # Also generate bowls and playoffs if in December/January
          MONTH=$(date +%-m)
          if [ "$MONTH" = "12" ] || [ "$MONTH" = "1" ]; then
            echo "Generating CFB bowls"
            node scripts/generate-static.js --sport CFB --season 2025 --week bowls --force || echo "CFB bowls generation completed with warnings"
            echo "Generating CFB playoffs"
            node scripts/generate-static.js --sport CFB --season 2025 --week playoffs --force || echo "CFB playoffs generation completed with warnings"
          fi

      - name: Generate NBA data
        if: contains(steps.determine.outputs.sport, 'NBA') || steps.determine.outputs.sport == 'all'
        run: |
          # Generate yesterday's games only (not future dates)
          YESTERDAY=$(date -d "yesterday" +%Y-%m-%d 2>/dev/null || date -v-1d +%Y-%m-%d)
          echo "Generating NBA data for $YESTERDAY"
          node scripts/generate-static.js --sport NBA --season 2025 --date $YESTERDAY ${{ steps.determine.outputs.force == 'true' && '--force' || '' }} || echo "NBA generation completed with warnings"

      - name: Check for generated files
        id: check_files
        run: |
          if [ -n "$(find public/data -name '*.json' -newer .git/index 2>/dev/null)" ]; then
            echo "has_new_files=true" >> $GITHUB_OUTPUT
            echo "New files detected:"
            find public/data -name '*.json' -newer .git/index
          else
            echo "has_new_files=false" >> $GITHUB_OUTPUT
            echo "No new files generated"
          fi

      - name: Commit and push changes
        if: steps.check_files.outputs.has_new_files == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/data/

          # Check if there are staged changes
          if git diff --staged --quiet; then
            echo "No changes to commit (files may already exist)"
          else
            git commit -m "Auto-generate static game data [skip ci]"

            # Pull with rebase to handle any new commits, then push with retry
            for i in 1 2 3; do
              echo "Push attempt $i..."
              git pull --rebase origin main && git push && break
              echo "Push failed, retrying in 5 seconds..."
              sleep 5
            done
            echo "Successfully committed and pushed new data"
          fi
